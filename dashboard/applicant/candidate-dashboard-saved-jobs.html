<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>CuroJobs - Saved Jobs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="56x56" href="../../images/fav-icon/icon.png">
	<link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" media="all">
	<link rel="stylesheet" type="text/css" href="../../css/style.css" media="all">
	<link rel="stylesheet" type="text/css" href="../../css/responsive.css" media="all">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

	</head>

<body>
	<div class="main-page-wrapper">
		<div id="preloader">
			<div id="ctn-preloader" class="ctn-preloader">
				<div class="icon"><img src="../../images/loader.svg" alt="" class="m-auto d-block" width="60"></div>
				<div class="txt-loading">
					<span data-text-preloader="C" class="letters-loading">
						C
					</span>
					<span data-text-preloader="U" class="letters-loading">
						U
					</span>
					<span data-text-preloader="R" class="letters-loading">
						R
					</span>
					<span data-text-preloader="O" class="letters-loading">
						O
					</span>
                    <span data-text-preloader="J" class="letters-loading">
						J
					</span>
                    <span data-text-preloader="O" class="letters-loading">
						O
					</span>
                    <span data-text-preloader="B" class="letters-loading">
						B
					</span>
                    <span data-text-preloader="S" class="letters-loading">
						S
					</span>
				</div>
			</div>
		</div>

		<aside class="dash-aside-navbar">
			<div class="position-relative">
				<div class="logo text-md-center d-md-block d-flex align-items-center justify-content-between">
					<a href="../../index.html">
						<img src="../../images/logo/logo_02.png" alt="" class="curo">
					</a>
					<button class="close-btn d-block d-md-none"><i class="bi bi-x-lg"></i></button>
				</div>
				<div class="user-data d-flex flex-column align-items-center">
                    <div id="user-avatar-placeholder" class="user-avatar online position-relative rounded-circle"></div>
                    <div class="user-name-data mt-2">
						<button class="user-name" id="profile-dropdown">
							Loading...
						</button>
					</div>
				</div>
                <nav class="dasboard-main-nav">
                    <ul class="style-none">
                        <li><a href="candidate-dashboard-index.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_1.svg" alt=""><span>Dashboard</span></a></li>
                        <li><a href="candidate-dashboard-profile.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_2.svg" alt=""><span>My Profile</span></a></li>
                        <li><a href="candidate-dashboard-saved-jobs.html" class="d-flex w-100 align-items-center active"><img src="../../images/icon/icon_6_active.svg" alt=""><span>Saved Jobs</span></a></li>
                        <li><a href="candidate-dashboard-job-alert.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_5.svg" alt=""><span>Job Alerts</span></a></li>
                        <li><a href="candidate-dashboard-message.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_4.svg" alt=""><span>Messages</span></a></li>
                        <li><a href="../../index.html" class="d-flex w-100 align-items-center mt-10 pt-10"><img src="../../images/icon/icon_30 copy.svg" alt=""><span>Back to Home</span></a></li>
                        <li><a href="#" id="logout-btn" class="d-flex w-100 align-items-center mt-10 pt-10"><img src="../../images/icon/icon_9.svg" alt=""><span>Logout</span></a></li>
                    </ul>
                </nav>
			</div>
		</aside>
		<div class="dashboard-body">
			<div class="position-relative">
				<header class="dashboard-header">
					<div class="d-flex align-items-center justify-content-end">
						<button class="dash-mobile-nav-toggler d-block d-md-none me-auto">
							<span></span>
						</button>
					</div>
				</header>
				<div class="d-flex align-items-center justify-content-between mb-40 lg-mb-30">
                    <h2 class="main-title m0">Saved Jobs</h2>
                    <div class="short-filter d-flex align-items-center">
                        <div class="text-dark fw-500 me-2">Sort by:</div>
                        <select class="nice-select" id="sort-saved-jobs">
                            <option value="latest">Latest Saved</option>
                            <option value="oldest">Oldest Saved</option>
                        </select>
                    </div>
                </div>

				<div class="wrapper" id="saved-jobs-container">
                    <div class="text-center p-5"><h4>Loading saved jobs...</h4></div>
				</div>

                <div class="dash-pagination d-flex justify-content-end mt-30" id="saved-jobs-pagination">
                </div>			
			</div>
		</div>
		        <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-fullscreen modal-dialog-centered">
                <div class="container">
                    <div class="remove-account-popup text-center modal-content">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						<img src="../../images/lazy.svg" data-src="images/icon/icon_22.svg" alt="" class="lazy-img m-auto">
						<h2>Are you sure?</h2>
						<p>Are you sure to delete your account? All data will be lost.</p>
						<div class="button-group d-inline-flex justify-content-center align-items-center pt-15">
							<a href="#" class="confirm-btn fw-500 tran3s me-3">Yes</a>
							<button type="button" class="btn-close fw-500 ms-3" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
						</div>
                    </div>
                                    </div>
            </div>
        </div>
		


		<button class="scroll-top">
			<i class="bi bi-arrow-up-short"></i>
		</button>




		<script src="../../vendor/jquery.min.js"></script>
		<script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
		<script src="../../vendor/wow/wow.min.js"></script>
		<script src="../../vendor/jquery.lazy.min.js"></script>
		<script src="../../vendor/jquery.counterup.min.js"></script>
		<script src="../../vendor/jquery.waypoints.min.js"></script>
		<script src="../../vendor/nice-select/jquery.nice-select.min.js"></script>
        <script src="../../vendor/jwt-decode.js"></script>
		<script src="../../js/theme.js"></script>
        
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) { window.location.href = '../../login.html'; return; }
                
                let currentUser;
                try {
                    currentUser = jwt_decode(accessToken);
                    if (currentUser.user_type !== 'applicant') { window.location.href = '../../index.html'; return; }
                } catch (e) {
                    localStorage.clear();
                    window.location.href = '../../login.html';
                    return;
                }
                
                // --- API Endpoints ---
                const BASE_API_URL = 'http://127.0.0.1:8000/api/v1/jobs/';
                const ACCOUNTS_API_URL = 'http://127.0.0.1:8000/api/v1/accounts/';
                
                // --- Elements ---
                const savedJobsContainer = document.getElementById('saved-jobs-container');
                const profileNameEl = document.getElementById('profile-dropdown');
                const avatarPlaceholder = document.getElementById('user-avatar-placeholder');
                const logoutBtn = document.getElementById('logout-btn');
                const sortSelect = document.getElementById('sort-saved-jobs');
                
                let savedJobsData = [];

                // --- Core API Fetch ---
                const apiFetch = async (endpoint, options = {}) => {
                    const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` };
                    const response = await fetch(endpoint, { ...options, headers });
                    if (response.status === 401) {
                        localStorage.clear();
                        window.location.href = '../../login.html';
                    }
                    return response;
                };

                // --- RENDERING ---

                const renderJobs = () => {
                    // Filter: Only show jobs that the user has NOT applied to.
                    const jobsToDisplay = savedJobsData.filter(job => !job.application_status);
                    
                    // Sort
                    const sortBy = sortSelect.value;
                    jobsToDisplay.sort((a, b) => {
                        // Assuming saved_at exists on the job object from the SavedJobSerializer response
                        if (sortBy === 'oldest') return new Date(a.saved_at) - new Date(b.saved_at);
                        return new Date(b.saved_at) - new Date(a.saved_at);
                    });
                    
                    savedJobsContainer.innerHTML = '';
                    
                    if (jobsToDisplay.length === 0 && savedJobsData.length > 0) {
                        savedJobsContainer.innerHTML = '<div class="text-center p-5"><h4>All your saved jobs have been applied to!</h4><p>Check your dashboard for application statuses.</p></div>';
                        return;
                    }
                    
                    if (jobsToDisplay.length === 0) {
                         savedJobsContainer.innerHTML = '<div class="text-center p-5"><h4>You have no saved jobs.</h4><a href="../../job-list-v1.html" class="btn-one">Browse Jobs</a></div>';
                        return;
                    }

                    jobsToDisplay.forEach(item => {
                        // The savedJobsData list contains SavedJob objects, which have a nested 'job' field
                        const job = item.job; 
                        const companyInitial = job.company_name ? job.company_name.charAt(0).toUpperCase() : '?';
                        const jobItem = document.createElement('div');
                        jobItem.className = 'job-list-one style-two position-relative mb-20';
                        jobItem.dataset.jobId = job.id;
                        
                        jobItem.innerHTML = `
                            <div class="row justify-content-between align-items-center">
                                <div class="col-xxl-3 col-lg-4">
                                    <div class="job-title d-flex align-items-center">
                                        <a href="../../job-details.html?id=${job.id}" class="logo">
                                            <div class="logo-initial d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; border-radius: 8px; background-color: #f0f5ff; font-size: 24px; font-weight: 500; color: #4866a6;">${companyInitial}</div>
                                        </a>
                                        <a href="../../job-details.html?id=${job.id}" class="title fw-500 tran3s">${job.title}</a>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-4 col-sm-6 ms-auto">
                                    <div class="job-duration fw-500">${job.job_type || 'N/A'}</div>
                                    <div class="job-salary"><span class="fw-500 text-dark">${job.salary || 'Competitive'}</span></div>
                                </div>
                                <div class="col-xxl-2 col-lg-3 col-md-4 col-sm-6 ms-auto xs-mt-10">
                                    <div class="job-location">
                                        <a href="#"><i class="bi bi-geo-alt"></i> ${job.location || 'N/A'}</a>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-4">
                                    <div class="action-buttons d-flex justify-content-end align-items-center">
                                        <a href="../../job-details.html?id=${job.id}" class="btn-one tran3s me-2" style="padding: 6px 14px; font-size: 14px;">Apply</a>
                                        <button class="action-btn remove-saved-job" data-job-id="${job.id}" title="Remove from Saved">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        savedJobsContainer.appendChild(jobItem);
                    });
                    
                    // Re-attach listeners for dynamically created buttons
                    document.querySelectorAll('.remove-saved-job').forEach(btn => btn.addEventListener('click', handleRemoveJob));
                };

                // --- HANDLERS ---
                
                const handleRemoveJob = async (e) => {
                    const jobId = e.currentTarget.dataset.jobId;
                    if (!jobId) return;

                    const confirmed = await Swal.fire({
                        title: 'Are you sure?',
                        text: "Do you want to remove this job from your saved list?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Yes, remove it!'
                    });

                    if (confirmed.isConfirmed) {
                        try {
                            // Using the new API endpoint for toggling saved status
                            const response = await apiFetch(`${BASE_API_URL}${jobId}/save/`, {
                                method: 'POST', 
                                body: JSON.stringify({ action: 'unsave' })
                            });
                            
                            if (!response.ok) throw new Error('Failed to remove job.');
                            
                            // Remove the job from the local cache and re-render
                            savedJobsData = savedJobsData.filter(item => item.job.id != jobId);
                            renderJobs();

                            Swal.fire('Removed!', 'The job has been removed from your saved list.', 'success');

                        } catch (error) {
                            Swal.fire('Error', error.message, 'error');
                        }
                    }
                };

                const fetchSavedJobs = async () => {
                    try {
                        const response = await apiFetch(`${BASE_API_URL}saved/`); 
                        if (!response.ok) throw new Error('Failed to fetch saved jobs.');
                        
                        // Assuming the API returns a list of SavedJob objects,
                        // each containing a nested 'job' field and the 'saved_at' timestamp.
                        savedJobsData = await response.json();
                        renderJobs();

                    } catch (error) {
                        savedJobsContainer.innerHTML = `<div class="text-center p-5 text-danger"><h4>Could not load saved jobs.</h4><p>${error.message}</p></div>`;
                    }
                };

                const fetchProfile = async () => {
                    try {
                        const response = await apiFetch(`${ACCOUNTS_API_URL}profile/applicant/`);
                        if (!response.ok) throw new Error('Failed to fetch profile');
                        const profile = await response.json();
                        const username = profile.full_name || profile.user.username || 'Applicant';
                        profileNameEl.textContent = username;
                        if (avatarPlaceholder) {
                            const initial = username.charAt(0).toUpperCase();
                            let hash = 0; for (let i = 0; i < username.length; i++) { hash = username.charCodeAt(i) + ((hash << 5) - hash); }
                            const color = `hsl(${hash % 360}, 50%, 60%)`;
                            avatarPlaceholder.style.cssText = `background-color:${color}; display:flex; align-items:center; justify-content:center; color:white; font-size:24px; font-weight:500;`;
                            avatarPlaceholder.innerHTML = initial;
                        }
                    } catch (error) { console.error(error); }
                };

                // --- INITIALIZATION ---
                $(sortSelect).on('change', renderJobs); 

                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.clear();
                    window.location.href = '../../index.html';
                });
                
                fetchProfile();
                fetchSavedJobs();
            });
        </script>
	</div> </body>

</html>