<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CuroJobs - Messages</title>
    <link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/style.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/responsive.css" media="all">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        /* Read-Only Message Bubbles */
        .email-body { display: flex; flex-direction: column; padding: 20px; gap: 15px; }
        .message-bubble { max-width: 75%; width: fit-content; padding: 10px 15px; border-radius: 18px; }
        .message-author { font-size: 13px; font-weight: 500; margin-bottom: 5px; }
        .message-text { white-space: pre-wrap; word-wrap: break-word; font-size: 15px; margin: 0; }
        .message-time { font-size: 11px; opacity: 0.7; margin-top: 5px; text-align: right; }
        
        .message-bubble.received { background-color: #f1f0f0; color: #333; border-bottom-left-radius: 4px; align-self: flex-start; }
        .message-bubble.received .message-author { color: #555; }
        
        /* Styling for the filter buttons from Jobi template */
        .message_filter { /* gap: 10px; */ }
        .message_filter .filter_btn {
            font-size: 14px;
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 20px;
            border: none; 
            background: #fff;
            color: #000;
            display: inline-flex;
            align-items: center;
        }
        .message_filter .filter_btn.active {
            background-color: #244034;
            color: #fff;
            border: 1px solid #244034;
        }
        .message_filter .filter_btn span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        /* Other styles */
        .date-separator { text-align: center; color: #999; font-size: 12px; padding: 15px 0; }
        .email-list-item.selected { background-color: #f0f5f3; border-left: 3px solid #244034; }
        .email-list-item.unread .sender-name,
        .email-list-item.unread .mail-sub {
            font-weight: 600;
            color: #000;
        }
        .notification-badge { position: absolute; top: 15px; right: 25px; height: 10px; width: 10px; background-color: #dc3545; border-radius: 50%; border: 2px solid white; display: none; }
    
        /* Pagination Styles */
        .message-pagination { padding: 10px 0; }
        .message-pagination button { 
            background: none; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            padding: 2px 8px; 
            width: 30px; 
            height: 30px; 
        }
        .message-pagination button:disabled { opacity: 0.4; cursor: not-allowed; }
        .message-pagination span { font-size: 14px; color: #555; margin: 0 10px; }

        /* Read/Unread Dots */
        .email-short-preview {
            padding-left: 15px; 
        }
        .email-short-preview::before {
            content: '';
            position: absolute;
            top: 18px; 
            left: 0; 
            width: 8px;
            height: 8px;
            background-color: transparent; 
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        .email-list-item.unread .email-short-preview::before {
            background-color: #3BDA84; /* GREEN */
        }
        .email-list-item:not(.unread) .email-short-preview::before {
             background-color: #FF4545; /* RED */
        }

        /* Search Form (from style.css) */
        .search-form {
            position: relative;
        }
        .search-form input {
            width: 100%;
            height: 45px;
            border: 1px solid #e8e8e8;
            border-radius: 5px;
            padding: 0 45px 0 15px;
            font-size: 14px;
        }
        .search-form button {
            position: absolute;
            right: 0;
            top: 0;
            width: 50px;
            height: 100%;
            border: none;
            background: transparent;
            border-radius: 0 5px 5px 0;
        }
        .search-form button img {
            width: 18px;
        }
    </style>
</head>

<body>
    <div class="main-page-wrapper">
        <aside class="dash-aside-navbar">
            <div class="position-relative">
                <div class="logo text-md-center"><a href="../../index.html"><img src="../../images/logo/logo_02.png" alt="" class="curo"></a></div>
                <div class="user-data d-flex flex-column align-items-center">
                    <div id="user-avatar-placeholder" class="user-avatar online position-relative rounded-circle"></div>
                    <div class="user-name-data mt-2">
                        <div class="user-name" id="profile-dropdown">
                            Loading...
                        </div>
                    </div>
                </div>
                <nav class="dasboard-main-nav">
                    <ul class="style-none">
                        <li><a href="candidate-dashboard-index.html" class="d-flex w-100 align-items-center active"><img src="../../images/icon/icon_1_active.svg" alt=""><span>Dashboard</span></a></li>
                        <li><a href="candidate-dashboard-profile.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_2.svg" alt=""><span>My Profile</span></a></li>
                        <li><a href="candidate-dashboard-saved-jobs.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_6_active.svg" alt=""><span>Saved Jobs</span></a></li>
                        <li><a href="candidate-dashboard-job-alert.html" class="d-flex w-100 align-items-center active"><img src="../../images/icon/icon_5_active.svg" alt=""><span>Job Alerts</span></a></li>
                        <li><a href="candidate-dashboard-message.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_4.svg" alt=""><span>Messages</span></a></li>
                        <li><a href="../../index.html" class="d-flex w-100 align-items-center border-top mt-10 pt-10"><img src="../../images/icon/icon_8.svg" alt=""><span>Back to Home</span></a></li>
                        <li><a href="#" id="logout-btn" class="d-flex w-100 align-items-center logout-btn"><img src="../../images/icon/icon_9.svg" alt=""><span>Logout</span></a></li>
                    </ul>
                </nav>
            </div>
        </aside>

        <div class="dashboard-body">
            <div class="position-relative">
                <header class="dashboard-header"></header>
                
                <div id="message-container-main" class="alert mt-3" style="display: none;"></div>
                
                <div class="row gx-0 align-items-center mb-30">
                    <div class="col-lg-4">
                        <h2 class="main-title m0">Messages</h2>
                    </div>
                    <div class="col-lg-8">
                        <div class="message-pagination ps-lg-4 ps-xxl-5 d-flex align-items-center justify-content-end md-mt-20">
                            <div class="d-flex align-items-center">
                                <button id="prev-page-btn" class="me-2" disabled><i class="bi bi-chevron-left"></i></button>
                                <span id="pagination-text">0-0 of 0</span>
                                <button id="next-page-btn" class="ms-2" disabled><i class="bi bi-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="bg-white card-box border-20 p0"> 
                    <div class="message-wrapper">
                        <div class="row gx-0">
                            <div class="col-lg-4">
                                <div class="message-sidebar pt-20">
                                    <div class="ps-3 pe-3 ps-xxl-4 pe-xxl-4">
                                        <div class="page-title fw-500">Inbox</div>
                                        
                                        <form action="#" class="search-form mt-20 mb-20" id="message-search-form">
											<input type="text" id="message-search-input" placeholder="Search contacts or subject...">
											<button type="submit"><img src="../../images/icon/icon_10.svg" alt="" class="m-auto"></button>
										</form>
                                        
                                        <div class="message_filter d-flex align-items-center justify-content-between flex-wrap my-20" id="module_btns">
											<button class="filter_btn active" data-filter="all">All</button>
											<button class="filter_btn" data-filter="unread"><span style="background:#3BDA84;"></span>Unread</button>
											<button class="filter_btn" data-filter="read"><span style="background:#FF4545;"></span>Read</button>
										</div>
                                    </div>
                                    
                                    <div id="conversation-list-container" class="email-read-panel">
                                        </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-8">
                                <div id="conversation-display-container" class="open-email-container d-flex flex-column" style="height: 75vh;">
                                     <div class="text-center p-5 m-auto">Select a conversation to view.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script src="../../vendor/jquery.min.js"></script>
        <script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="../../vendor/jwt-decode.js"></script>
        <script src="../../js/theme.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) { window.location.href = '../../login.html'; return; }
                
                let currentUser;
                try {
                    currentUser = jwt_decode(accessToken);
                    if (currentUser.user_type !== 'applicant') { window.location.href = '../../index.html'; return; }
                } catch (e) {
                    localStorage.clear();
                    window.location.href = '../../login.html';
                    return;
                }

                // --- Global State ---
                let conversations = {}; 
                let allMessages = []; 
                let currentFilter = 'all'; 
                let currentPage = 1;
                let currentSearch = ''; // NEW: Search state
                const MESSAGES_PER_PAGE = 25;

                // --- Element Selectors ---
                const conversationListContainer = document.getElementById('conversation-list-container');
                const conversationDisplayContainer = document.getElementById('conversation-display-container');
                const profileNameEl = document.getElementById('profile-dropdown');
                const logoutBtn = document.getElementById('logout-btn');
                const avatarPlaceholder = document.getElementById('user-avatar-placeholder');
                const mainMessageContainer = document.getElementById('message-container-main');
                const paginationText = document.getElementById('pagination-text');
                const prevPageBtn = document.getElementById('prev-page-btn');
                const nextPageBtn = document.getElementById('next-page-btn');
                const searchForm = document.getElementById('message-search-form'); // NEW
                const searchInput = document.getElementById('message-search-input'); // NEW
                
                const baseApiURL = 'http://127.0.0.1:8000/api/v1/accounts/';

                // --- API & Utility Functions ---
                const apiFetch = async (endpoint, options = {}) => {
                    const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` };
                    const response = await fetch(`${baseApiURL}${endpoint}`, { ...options, headers });
                    if (response.status === 401) {
                        localStorage.clear();
                        window.location.href = '../../login.html';
                    }
                    return response;
                };

                const showMessage = (message, isError = false) => {
                    mainMessageContainer.textContent = message;
                    mainMessageContainer.className = `alert ${isError ? 'alert-danger' : 'alert-success'}`;
                    mainMessageContainer.style.display = 'block';
                    setTimeout(() => { mainMessageContainer.style.display = 'none'; }, 3000);
                };
                
                const getConversationId = (msg) => {
                    const participantIds = [msg.sender, msg.recipient].sort();
                    const baseSubject = msg.subject.replace(/^(Re: )+/i, '').trim();
                    return `${participantIds[0]}-${participantIds[1]}-${baseSubject}`;
                };

                const checkUnreadMessages = async () => {
                    try {
                        const response = await apiFetch('messages/unread-count/');
                        if (!response.ok) return;
                        const data = await response.json();
                        const badge = document.querySelector('#messages-nav-item .notification-badge');
                        if (badge && data.unread_count > 0) {
                            badge.style.display = 'block';
                        } else if (badge) {
                            badge.style.display = 'none';
                        }
                    } catch (error) { console.error("Could not check for unread messages.", error); }
                };

                // --- Core Logic Functions ---
                const displayConversation = async (conversationId) => {
                    const conversation = conversations[conversationId];
                    if (!conversation) return;

                    if (conversation.isUnread) {
                        try {
                            await apiFetch('messages/mark-as-read/', {
                                method: 'POST',
                                body: JSON.stringify({ sender_id: conversation.otherUserId })
                            });
                            conversation.isUnread = false; 
                            checkUnreadMessages(); 
                            renderConversationList(); 
                        } catch (error) { console.error("Could not mark messages as read.", error); }
                    }
                    
                    const { otherUserName, messages } = conversation;
                    let messagesHtml = '';
                    let lastDate = null;
                    
                    messages.forEach(msg => {
                        const msgDate = new Date(msg.sent_at).toLocaleDateString();
                        if (lastDate !== msgDate) {
                            messagesHtml += `<div class="date-separator">--- ${new Date(msg.sent_at).toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'})} ---</div>`;
                            lastDate = msgDate;
                        }
                        
                        const time = new Date(msg.sent_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        const authorName = (msg.sender === currentUser.user_id) ? 'You (via reply)' : otherUserName;
                        
                        messagesHtml += `
                            <div class="message-bubble received">
                                <div class="message-author">${authorName}</div>
                                <p class="message-text">${msg.body.replace(/\n/g, '<br>')}</p>
                                <div class="message-time">${time}</div>
                            </div>`;
                    });

                    conversationDisplayContainer.innerHTML = `
                        <div class="email-header divider d-flex justify-content-between ps-4 pe-4">
                            <div class="sender-info d-flex align-items-center">
                                <div class="ps-3">
                                    <div class="sender-name fw-500">${otherUserName}</div>
                                </div>
                            </div>
                        </div>
                        <div class="email-body flex-grow-1" style="overflow-y: auto;">
                            ${messagesHtml}
                        </div>
                    `;
                    
                    const emailBody = conversationDisplayContainer.querySelector('.email-body');
                    emailBody.scrollTop = emailBody.scrollHeight;
                };
                
                const renderConversationList = () => {
                    conversationListContainer.innerHTML = '';

                    // 1. Filter by Status
                    let filteredConversations = Object.values(conversations);
                    if (currentFilter === 'unread') {
                        filteredConversations = filteredConversations.filter(c => c.isUnread);
                    } else if (currentFilter === 'read') {
                        filteredConversations = filteredConversations.filter(c => !c.isUnread);
                    }

                    // 2. NEW: Filter by Search
                    if (currentSearch) {
                        filteredConversations = filteredConversations.filter(conv => 
                            (conv.otherUserName && conv.otherUserName.toLowerCase().includes(currentSearch)) ||
                            (conv.baseSubject && conv.baseSubject.toLowerCase().includes(currentSearch))
                        );
                    }

                    // 3. Sort
                    filteredConversations.sort((a, b) => new Date(b.lastMessage.sent_at) - new Date(a.lastMessage.sent_at));

                    // 4. Paginate
                    const totalFiltered = filteredConversations.length;
                    const startIndex = (currentPage - 1) * MESSAGES_PER_PAGE;
                    const endIndex = startIndex + MESSAGES_PER_PAGE;
                    const paginatedConversations = filteredConversations.slice(startIndex, endIndex);

                    // 5. Update Pagination UI
                    paginationText.textContent = `${totalFiltered > 0 ? startIndex + 1 : 0}-${Math.min(endIndex, totalFiltered)} of ${totalFiltered}`;
                    prevPageBtn.disabled = (currentPage === 1);
                    nextPageBtn.disabled = (endIndex >= totalFiltered);

                    // 6. Render List
                    if (paginatedConversations.length === 0) { 
                        if (currentSearch) {
                            conversationListContainer.innerHTML = '<p class="text-center p-3">No messages match your search.</p>';
                        } else {
                            conversationListContainer.innerHTML = '<p class="text-center p-3">No messages match this filter.</p>';
                        }
                        return;
                    }

                    const currentSelectedId = document.querySelector('.email-list-item.selected')?.dataset.conversationId;

                    paginatedConversations.forEach((conv) => {
                        const convItem = document.createElement('div');
                        convItem.className = 'email-list-item ps-3 pe-3 ps-xxl-4 pe-xxl-4';
                        if (conv.isUnread) { convItem.classList.add('unread'); }
                        
                        if (currentSelectedId && currentSelectedId === conv.id) {
                            convItem.classList.add('selected');
                        }

                        convItem.dataset.conversationId = conv.id;
                        const sentDate = new Date(conv.lastMessage.sent_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        
                        convItem.innerHTML = `
                            <div class="email-short-preview position-relative">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="sender-name fw-500">${conv.otherUserName}</div>
                                    <div class="date">${sentDate}</div>
                                </div>
                                <div class="mail-sub">${conv.lastMessage.subject}</div>
                                <div class="mail-text">${conv.lastMessage.body.substring(0, 40)}...</div>
                            </div>`;
                        
                        convItem.addEventListener('click', () => {
                            document.querySelectorAll('.email-list-item.selected').forEach(el => el.classList.remove('selected'));
                            convItem.classList.add('selected');
                            displayConversation(conv.id);
                        });
                        conversationListContainer.appendChild(convItem);
                    });
                };

                const fetchMessages = async () => {
                    try {
                        const response = await apiFetch('messages/');
                        if (!response.ok) throw new Error('Failed to fetch messages');
                        allMessages = await response.json();
                        
                        conversations = {};
                        const tempConversations = {};

                        allMessages.forEach(msg => {
                            if (msg.sender === msg.recipient) return;
                            const conversationId = getConversationId(msg);
                            if (!tempConversations[conversationId]) {
                                tempConversations[conversationId] = { messages: [] };
                            }
                            tempConversations[conversationId].messages.push(msg);
                        });

                        for (const id in tempConversations) {
                            const tempConv = tempConversations[id];
                            let otherUserId = null;
                            let otherUserName = 'Unknown User';

                            const firstMessageFromOther = tempConv.messages.find(m => m.sender !== currentUser.user_id);
                            if (firstMessageFromOther) {
                                otherUserId = firstMessageFromOther.sender;
                                otherUserName = firstMessageFromOther.sender_username;
                            } else {
                                const firstMessageSent = tempConv.messages[0];
                                if(firstMessageSent){
                                    otherUserId = firstMessageSent.recipient;
                                    otherUserName = firstMessageSent.recipient_username;
                                } else {
                                    continue; 
                                }
                            }

                            const baseSubject = getConversationId(tempConv.messages[0]).split('-').slice(2).join('-');
                            tempConv.messages.sort((a, b) => new Date(a.sent_at) - new Date(b.sent_at));
                            const lastMessage = tempConv.messages[tempConv.messages.length - 1];
                            const isUnread = tempConv.messages.some(m => !m.is_read && m.sender !== currentUser.user_id);

                            conversations[id] = { id, otherUserId, otherUserName, baseSubject, messages: tempConv.messages, lastMessage, isUnread };
                        }
                        
                        renderConversationList();
                        
                        const firstConv = document.querySelector('.email-list-item');
                        if (firstConv) {
                            firstConv.click();
                        } else {
                            conversationDisplayContainer.innerHTML = '<div class="text-center p-5 m-auto">Your inbox is empty.</div>';
                        }
                    } catch (error) {
                        console.error(error);
                        conversationListContainer.innerHTML = '<p class="text-center text-danger p-3">Could not load messages.</p>';
                    }
                };
                
                const fetchProfile = async () => {
                    try {
                        const response = await apiFetch('profile/applicant/');
                        if (!response.ok) throw new Error('Failed to fetch profile');
                        const profile = await response.json();
                        const username = profile.full_name || profile.username || 'Applicant';
                        profileNameEl.textContent = username;

                        if (avatarPlaceholder) {
                            const initial = username.charAt(0).toUpperCase();
                            let hash = 0;
                            for (let i = 0; i < username.length; i++) { hash = username.charCodeAt(i) + ((hash << 5) - hash); }
                            const color = `hsl(${hash % 360}, 50%, 60%)`;
                            avatarPlaceholder.style.cssText = `background-color:${color}; display:flex; align-items:center; justify-content:center; color:white; font-size:24px; font-weight:500;`;
                            avatarPlaceholder.innerHTML = initial;
                        }
                    } catch (error) { console.error(error); }
                };
                
                // --- Event Listeners ---

                // NEW: Search Listener
                searchForm.addEventListener('submit', (e) => e.preventDefault()); // Prevent page reload on Enter
                searchInput.addEventListener('input', () => {
                    currentSearch = searchInput.value.toLowerCase();
                    currentPage = 1;
                    renderConversationList();
                    
                    const firstConv = document.querySelector('.email-list-item');
                    if (firstConv) {
                        firstConv.click();
                    } else {
                        // Clear the display
                        conversationDisplayContainer.innerHTML = '<div class="text-center p-5 m-auto">No messages match your search.</div>';
                    }
                });

                // Filter Buttons
                document.querySelectorAll('.filter_btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelector('.filter_btn.active').classList.remove('active');
                        btn.classList.add('active');
                        currentFilter = btn.dataset.filter;
                        currentPage = 1;
                        renderConversationList();
                        
                        const firstConv = document.querySelector('.email-list-item');
                        if (firstConv) {
                            firstConv.click();
                        } else {
                            conversationDisplayContainer.innerHTML = '<div class="text-center p-5 m-auto">No messages match this filter.</div>';
                        }
                    });
                });

                // Pagination Buttons
                prevPageBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderConversationList();
                    }
                });

                nextPageBtn.addEventListener('click', () => {
                    const totalFiltered = Object.values(conversations).filter(c => 
                        currentFilter === 'all' || 
                        (currentFilter === 'read' && !c.isUnread) ||
                        (currentFilter === 'unread' && c.isUnread)
                    ).length;
                    
                    if (currentPage * MESSAGES_PER_PAGE < totalFiltered) {
                        currentPage++;
                        renderConversationList();
                    }
                });

                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.clear();
                    window.location.href = '../../index.html';
                });

                // --- Initial Load ---
                fetchProfile();
                fetchMessages();
                checkUnreadMessages();
            });
        </script>
    </div>
</body>

</html>