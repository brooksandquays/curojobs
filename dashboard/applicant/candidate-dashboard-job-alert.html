<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>CuroJobs - Job Alerts</title>
    <link rel="icon" type="image/png" sizes="56x56" href="../../images/fav-icon/icon.png">
	<link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" media="all">
	<link rel="stylesheet" type="text/css" href="../../css/style.css" media="all">
	<link rel="stylesheet" type="text/css" href="../../css/responsive.css" media="all">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Custom styles to match the required table design */
        .job-alert-table th, .job-alert-table td {
            vertical-align: middle;
        }
        .job-alert-table th:nth-child(2), .job-alert-table td:nth-child(2) { width: 40%; } /* Alert Details Column */
        .job-alert-table th:nth-child(3), .job-alert-table td:nth-child(3) { width: 10%; } /* Jobs Found Column */
        .job-alert-table th:nth-child(4), .job-alert-table td:nth-child(4) { width: 15%; } /* Frequency Column */
        .job-alert-table th:nth-child(5), .job-alert-table td:nth-child(5) { width: 15%; } /* Actions Column */
    </style>
</head>

<body>
	<div class="main-page-wrapper">
		<aside class="dash-aside-navbar">
			<div class="position-relative">
				<div class="logo text-md-center d-md-block d-flex align-items-center justify-content-between">
					<a href="../../index.html"><img src="../../images/logo/logo_02.png" alt="" class="curo"></a>
				</div>
				<div class="user-data d-flex flex-column align-items-center">
                    <div id="user-avatar-placeholder" class="user-avatar online position-relative rounded-circle"></div>
                    <div class="user-name-data mt-2">
						<div class="user-name" id="profile-dropdown">Loading...</div>
					</div>
				</div>
				<nav class="dasboard-main-nav">
					<ul class="style-none">
						<li><a href="candidate-dashboard-index.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_1.svg" alt=""><span>Dashboard</span></a></li>
						<li><a href="candidate-dashboard-profile.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_2.svg" alt=""><span>My Profile</span></a></li>
						<li><a href="candidate-dashboard-message.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_4.svg" alt=""><span>Messages</span></a></li>
						<li><a href="candidate-dashboard-saved-jobs.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_6.svg" alt=""><span>Saved Jobs</span></a></li>
						<li><a href="candidate-dashboard-job-alert.html" class="d-flex w-100 align-items-center active"><img src="../../images/icon/icon_5_active.svg" alt=""><span>Job Alerts</span></a></li>
						<li><a href="candidate-dashboard-settings.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_7.svg" alt=""><span>Account Settings</span></a></li>
						<li><a href="../../index.html" class="d-flex w-100 align-items-center border-top mt-10 pt-10"><img src="../../images/icon/icon_8.svg" alt=""><span>Back to Home</span></a></li>
						<li><a href="#" id="logout-btn" class="d-flex w-100 align-items-center logout-btn"><img src="../../images/icon/icon_9.svg" alt=""><span>Logout</span></a></li>
					</ul>
				</nav>
			</div>
		</aside>

		<div class="dashboard-body">
			<div class="position-relative">
				<header class="dashboard-header">
					<div class="d-flex align-items-center justify-content-end">
						<button class="dash-mobile-nav-toggler d-block d-md-none me-auto"><span></span></button>
					</div>
				</header>

				<h2 class="main-title">Job Alerts</h2>
				<p class="mb-40 lg-mb-30">Set up email notifications for new job postings that match your desired titles/keywords.</p>

				<div class="bg-white card-box border-20 p25">
					<h4 class="dash-title-three">Create New Alert</h4>
					<form id="new-alert-form" class="row">
						<div class="col-lg-8">
							<div class="dash-input-wrapper mb-25">
								<label for="new-keyword">Job Title or Keyword*</label>
								<input type="text" id="new-keyword" name="keyword" placeholder="e.g., Registered Nurse, Social Worker" required>
							</div>
						</div>
						<div class="col-lg-4">
							<div class="dash-input-wrapper mb-25">
								<button type="submit" id="add-alert-btn" class="dash-btn-two tran3s mt-30 w-100">Add Alert</button>
							</div>
						</div>
						<div class="col-12"><div id="alert-message-container" class="alert" style="display: none;"></div></div>
					</form>
				</div>
                
                <h4 class="dash-title-three mt-50">Active Alerts</h4>

				<div class="wrapper mt-20">
					<div class="table-responsive">
						<table class="table job-alert-table">
							<thead>
								<tr>
									<th scope="col">Keyword</th>
									<th scope="col">Last Sent</th>
									<th scope="col">Action</th>
								</tr>
							</thead>
							<tbody id="alerts-table-body">
								<tr><td colspan="3" class="text-center">Loading alerts...</td></tr>
							</tbody>
						</table>
					</div>
				</div>
                
			</div>
		</div>
		</div>


    <button class="scroll-top">
        <i class="bi bi-arrow-up-short"></i>
    </button>


	<script src="../../vendor/jquery.min.js"></script>
	<script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="../../vendor/wow/wow.min.js"></script>
	<script src="../../vendor/jquery.lazy.min.js"></script>
	<script src="../../vendor/nice-select/jquery.nice-select.min.js"></script>
    <script src="../../vendor/jwt-decode.js"></script>
	<script src="../../js/theme.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) { window.location.href = '../../login.html'; return; }
            
            let currentUser;
            try {
                currentUser = jwt_decode(accessToken);
                if (currentUser.user_type !== 'applicant') { window.location.href = '../../index.html'; return; }
            } catch (e) {
                localStorage.clear();
                window.location.href = '../../login.html';
                return;
            }

            // --- API Endpoints ---
            // Matches the URL defined in jobs/urls.py
            const ALERTS_API_URL = 'http://127.0.0.1:8000/api/v1/jobs/alerts/'; 
            const ACCOUNTS_API_URL = 'http://127.0.0.1:8000/api/v1/accounts/';
            
            // --- Elements ---
            const profileNameEl = document.getElementById('profile-dropdown');
            const avatarPlaceholder = document.getElementById('user-avatar-placeholder');
            const logoutBtn = document.getElementById('logout-btn');
            const alertsTableBody = document.getElementById('alerts-table-body');
            const newAlertForm = document.getElementById('new-alert-form');
            const newKeywordInput = document.getElementById('new-keyword');
            const addAlertBtn = document.getElementById('add-alert-btn');
            const alertMessageContainer = document.getElementById('alert-message-container');

            // --- UTILITY: API Fetch ---
            const apiFetch = async (endpoint, options = {}) => {
                const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` };
                const response = await fetch(endpoint, { ...options, headers });
                if (response.status === 401) {
                    localStorage.clear();
                    window.location.href = '../../login.html';
                }
                return response;
            };
            
            // --- UTILITY: Message Display ---
            const showMessage = (message, isError = false) => {
                alertMessageContainer.innerHTML = message;
                alertMessageContainer.className = `alert ${isError ? 'alert-danger' : 'alert-success'}`;
                alertMessageContainer.style.display = 'block';
                setTimeout(() => { alertMessageContainer.style.display = 'none'; }, 4000);
            };

            // --- PROFILE INIT ---
            const fetchProfile = async () => {
                try {
                    const response = await apiFetch(`${ACCOUNTS_API_URL}profile/applicant/`);
                    if (!response.ok) throw new Error('Failed to fetch profile');
                    const profile = await response.json();
                    const username = profile.full_name || profile.username || 'Applicant';
                    profileNameEl.textContent = username;
                    if (avatarPlaceholder) {
                        const initial = username.charAt(0).toUpperCase();
                        let hash = 0; for (let i = 0; i < username.length; i++) { hash = username.charCodeAt(i) + ((hash << 5) - hash); }
                        const color = `hsl(${hash % 360}, 50%, 60%)`;
                        avatarPlaceholder.style.cssText = `background-color:${color}; display:flex; align-items:center; justify-content:center; color:white; font-size:24px; font-weight:500;`;
                        avatarPlaceholder.innerHTML = initial;
                    }
                } catch (error) { console.error('Error fetching profile:', error); }
            };

            // --- CRUD HANDLERS ---
            
            const renderAlerts = (alerts) => {
                alertsTableBody.innerHTML = '';
                if (alerts.length === 0) {
                    alertsTableBody.innerHTML = '<tr><td colspan="3" class="text-center p-3">You have no active job alerts.</td></tr>';
                    return;
                }

                alerts.forEach(alert => {
                    const row = document.createElement('tr');
                    
                    // Format Last Sent date
                    const lastSentDate = alert.last_sent 
                        ? new Date(alert.last_sent).toLocaleDateString() + ' ' + new Date(alert.last_sent).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                        : 'Never';

                    row.innerHTML = `
                        <td>${alert.keyword}</td>
                        <td>${lastSentDate}</td>
                        <td>
                            <button class="dash-btn-two delete-alert-btn" data-alert-id="${alert.id}">
                                <i class="bi bi-trash"></i> Remove
                            </button>
                        </td>
                    `;
                    alertsTableBody.appendChild(row);
                });
                
                document.querySelectorAll('.delete-alert-btn').forEach(btn => {
                    btn.addEventListener('click', handleDeleteAlert);
                });
            };

            const fetchAlerts = async () => {
                alertsTableBody.innerHTML = '<tr><td colspan="3" class="text-center">Loading alerts...</td></tr>';
                try {
                    const response = await apiFetch(ALERTS_API_URL);
                    if (!response.ok) throw new Error('Failed to fetch alerts.');
                    const alerts = await response.json();
                    renderAlerts(alerts);
                } catch (error) {
                    alertsTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">Error: ${error.message}</td></tr>`;
                    console.error(error);
                }
            };
            
            const handleCreateAlert = async (e) => {
                e.preventDefault();
                const keyword = newKeywordInput.value.trim();
                if (!keyword) return;

                addAlertBtn.disabled = true;
                addAlertBtn.textContent = 'Adding...';

                try {
                    const response = await apiFetch(ALERTS_API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ keyword: keyword })
                    });

                    if (response.status === 201) {
                        showMessage(`Alert for '${keyword}' added successfully!`, false);
                        newKeywordInput.value = '';
                    } else if (response.status === 400) {
                        const error = await response.json();
                        let errorMessage = error.keyword ? `Keyword: ${error.keyword[0]}` : 'Alert already exists.';
                        // Check for the unique_together error message explicitly
                        if (error.non_field_errors && error.non_field_errors[0].includes('already exists')) {
                            errorMessage = 'Alert for this keyword already exists.';
                        }
                        showMessage(errorMessage, true);
                    } else {
                        throw new Error('Failed to create alert.');
                    }
                    
                    fetchAlerts();

                } catch (error) {
                    showMessage(error.message, true);
                } finally {
                    addAlertBtn.disabled = false;
                    addAlertBtn.textContent = 'Add Alert';
                }
            };
            
            const handleDeleteAlert = async (e) => {
                const alertId = e.currentTarget.dataset.alertId;
                if (!alertId) return;

                if (!confirm("Are you sure you want to remove this job alert?")) return;

                try {
                    // Endpoint uses alerts/<id>/
                    const response = await apiFetch(`${ALERTS_API_URL}${alertId}/`, {
                        method: 'DELETE',
                    });

                    if (response.status === 204) {
                        showMessage('Alert successfully removed.', false);
                        fetchAlerts();
                    } else {
                        throw new Error('Failed to delete alert.');
                    }
                } catch (error) {
                    showMessage(error.message, true);
                }
            };

            // --- INITIALIZATION ---
            newAlertForm.addEventListener('submit', handleCreateAlert);
            
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.clear();
                window.location.href = '../../index.html';
            });
            
            fetchProfile();
            fetchAlerts();
        });
    </script>
</body>
</html>