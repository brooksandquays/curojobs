<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CuroJobs - Company Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <link rel="icon" type="image/png" sizes="56x56" href="../../images/fav-icon/icon.png">
    <link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/style.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/responsive.css" media="all">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        /* --- Sidebar User Data Alignment --- */
        .dash-aside-navbar .user-data {
            display: flex;         /* Use flexbox for alignment */
            flex-direction: column; /* Stack items vertically */
            align-items: center;   /* Center items horizontally */
            text-align: center;    /* Center the text within the name container */
            margin-bottom: 20px;   /* Add some space below the name */
            padding-top: 15px;      /* Add some top padding */
        }

        .dash-aside-navbar .user-avatar {
            width: 60px;          /* Set a specific size for the logo container */
            height: 60px;
            margin-bottom: 10px;   /* Add space between logo and name */
        }
        
        /* Ensure image fills the circle */
        .dash-aside-navbar .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .dash-aside-navbar .user-name-data {
            margin-top: 0;         /* Remove default top margin if any */
        }

        .dash-aside-navbar .user-name {
            font-size: 16px;       /* Adjust font size as needed */
            font-weight: 500;
            color: #333;          /* Adjust text color if needed */
        }
        
        /* Ensure placeholder fits */
         #company-logo-preview {
             width: 100%; 
             height: 100%; 
             object-fit: cover;
         }
    </style>
</head>

<body>
<div class="main-page-wrapper">
    <aside class="dash-aside-navbar">
        <div class="position-relative">
            <div class="logo text-md-center d-flex align-items-center justify-content-between">
                <a href="../../index.html"><img src="../../images/logo/logo_02.png" alt="" class="curo"></a>
                 <button class="close-btn d-block d-md-none"><i class="bi bi-x-lg"></i></button> 
            </div>
            <div class="user-data">
                <div class="user-avatar online position-relative rounded-circle">
                    <img id="company-logo-preview" src="../../images/placeholder.jpeg" alt="" class="lazy-img" style="width:100%; height:100%; object-fit: cover;">
                </div>
                <div class="user-name-data">
                    <div class="user-name" id="profile-dropdown">Loading...</div>
                </div>
            </div>
            <nav class="dasboard-main-nav">
                <ul class="style-none">
                    <li><a href="employer-dashboard-index.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_1.svg" alt=""><span>Dashboard</span></a></li>
                    <li><a href="employer-dashboard-profile.html" class="d-flex w-100 align-items-center active"><img src="../../images/icon/icon_2_active.svg" alt=""><span>My Profile</span></a></li>
                    <li><a href="employer-dashboard-jobs.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_3.svg" alt=""><span>My Jobs</span></a></li>
                    <li><a href="employer-dashboard-submit-job.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_39 copy.svg" alt=""><span>Submit Job</span></a></li>
                    <li id="messages-nav-item" style="position: relative;">
                        <a href="employer-dashboard-message.html" class="d-flex w-100 align-items-center">
                            <img src="../../images/icon/icon_4.svg" alt=""><span>Messages</span>
                        </a>
                        <span class="notification-badge" style="position: absolute; top: 15px; right: 25px; height: 10px; width: 10px; background-color: #dc3545; border-radius: 50%; border: 2px solid white; display: none;"></span> </li>
                    <li><a href="employer-dashboard-message-setting.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_7.svg" alt=""><span>Msg Settings</span></a></li>
                    <li><a href="../../index.html" class="d-flex w-100 align-items-center mt-10 pt-10"><img src="../../images/icon/icon_30 copy.svg" alt=""><span>Back to Home</span></a></li>
                    <li><a href="#" id="logout-btn" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_9.svg" alt=""><span>Logout</span></a></li>
                </ul>
            </nav>
        </div>
    </aside>

    <div class="dashboard-body">
        <div class="position-relative">
            <header class="dashboard-header">
                 <div class="d-flex align-items-center justify-content-end"> 
                    <button class="dash-mobile-nav-toggler d-block d-md-none me-auto"><span></span></button>
                 </div>
            </header>
            <h2 class="main-title">Profile</h2>
            <div id="message-container" class="alert" style="display:none;"></div>

            <form id="profile-form" enctype="multipart/form-data">
                <div class="bg-white card-box border-20">

                    <div class="user-avatar-setting d-flex align-items-center mb-30">
                        <img id="company-logo-display" src="../../images/placeholder.jpeg" alt="" class="lazy-img user-img rounded-circle" style="width:80px;height:80px;object-fit:cover;">
                        <div class="upload-btn position-relative tran3s ms-4 me-3">
                            Upload Company Logo
                            <input type="file" id="logo" name="logo" accept="image/*">
                        </div>
                        <button type="button" id="delete-logo-btn" class="delete-btn tran3s">Delete</button>
                    </div>

                    <div class="dash-input-wrapper mb-30">
                        <label for="name">Company Name*</label>
                        <input type="text" id="name" name="name" placeholder="Your Company Name Inc." required>
                    </div>
                    <div class="dash-input-wrapper mb-30">
                        <label for="website">Website*</label>
                        <input type="url" id="website" name="website" placeholder="https://yourcompany.com" required>
                    </div>
                     <div class="dash-input-wrapper mb-30"> 
                         <label for="location">Location*</label>
                         <input type="text" id="location" name="location" placeholder="e.g., City, State or Full Address" required>
                     </div>
                    <div class="dash-input-wrapper">
                        <label for="description">About Company*</label>
                        <textarea id="description" name="description" class="size-lg" placeholder="Write something interesting about your company...." required></textarea>
                    </div>
                </div>

                <div class="button-group d-inline-flex align-items-center mt-30">
                    <button type="submit" class="dash-btn-two tran3s me-3">Save Changes</button>
                    </div>
            </form>
        </div>
    </div>

        <script src="../../vendor/jquery.min.js"></script>
        <script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="../../vendor/wow/wow.min.js"></script>
        <script src="../../vendor/jquery.lazy.min.js"></script>
        <script src="../../vendor/nice-select/jquery.nice-select.min.js"></script>
        <script src="../../vendor/jwt-decode.js"></script>
        <script src="../../js/theme.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) { window.location.href = '../../login.html'; return; }

            let currentUser;
            try {
                currentUser = jwt_decode(accessToken);
                if (!currentUser || currentUser.user_type !== 'company') {
                    localStorage.clear(); // Clear invalid token data
                    window.location.href = '../../login.html';
                    return;
                }
            } catch (e) {
                localStorage.clear();
                window.location.href = '../../login.html';
                return;
            }

            const apiURL = 'http://127.0.0.1:8000/api/v1/accounts/profile/company/';
            const profileForm = document.getElementById('profile-form');
            const profileNameEl = document.getElementById('profile-dropdown');
            const messageContainer = document.getElementById('message-container');
            const logoInput = document.getElementById('logo');
            const logoDisplay = document.getElementById('company-logo-display');
            const logoPreview = document.getElementById('company-logo-preview'); // Sidebar logo
            const deleteLogoBtn = document.getElementById('delete-logo-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const saveButton = profileForm.querySelector('button[type="submit"]');

            // --- API Fetch Utility ---
            const apiFetch = async (endpoint, options = {}) => {
                const headers = options.body instanceof FormData
                    ? { 'Authorization': `Bearer ${accessToken}` }
                    : { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` };
                options.method = options.method || 'GET'; // Default to GET

                try {
                    const response = await fetch(endpoint, { ...options, headers });
                    if (response.status === 401) { 
                        localStorage.clear();
                        window.location.href = '../../login.html';
                        throw new Error('Unauthorized'); // Stop further processing
                    }
                    return response;
                } catch (error) {
                    console.error("API Fetch Error:", error);
                    if (error.message === 'Unauthorized') throw error; // Re-throw to be caught by caller
                    showMessage(`Network error: ${error.message}. Please check connection.`, true);
                    throw new Error('Network error during API fetch.'); // Throw generic for caller
                }
            };

            // --- Show Message Utility ---
            const showMessage = (msg, isError = false) => {
                messageContainer.textContent = msg;
                messageContainer.className = `alert ${isError ? 'alert-danger' : 'alert-success'} mb-20`;
                messageContainer.style.display = 'block';
                window.scrollTo(0, 0); // Scroll to top to see message
                 setTimeout(() => { messageContainer.style.display = 'none'; }, 4000);
            };

            // --- Load Profile Data ---
            const loadProfileData = async () => {
                try {
                    const response = await apiFetch(apiURL);
                    if (!response.ok) throw new Error(`Could not load profile (${response.status})`);
                    const data = await response.json();

                    // Update sidebar name
                    profileNameEl.textContent = data.name || 'Employer'; 
                    
                    // Populate form fields
                    document.getElementById('name').value = data.name || '';
                    document.getElementById('description').value = data.description || '';
                    document.getElementById('website').value = data.website || '';
                    document.getElementById('location').value = data.location || ''; // Added location field

                    // Update logo displays (form and sidebar)
                    const logoUrl = data.logo || '../../images/placeholder.jpeg';
                    logoDisplay.src = logoUrl;
                    logoPreview.src = logoUrl; 
                    
                    // Update localStorage with the latest logo URL from API
                    localStorage.setItem('companyLogo', logoUrl);

                } catch(error) {
                    // Avoid duplicate messages if apiFetch already showed one
                    if (error.message !== 'Unauthorized' && error.message !== 'Network error during API fetch.') {
                         showMessage(`Could not load profile data: ${error.message}. Please refresh.`, true);
                    }
                    console.error("Profile load error:", error);
                     // Set defaults if load fails
                     profileNameEl.textContent = 'Employer';
                     const placeholder = '../../images/placeholder.jpeg';
                     logoDisplay.src = placeholder;
                     logoPreview.src = placeholder;
                }
            };

            // --- Use localStorage for Instant Sidebar Logo Update ---
            const savedLogo = localStorage.getItem('companyLogo');
            if (savedLogo) {
                logoPreview.src = savedLogo; 
            } else {
                 logoPreview.src = '../../images/placeholder.jpeg'; // Fallback
            }

            // --- Event Listeners ---

            // Preview selected logo instantly
            logoInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        logoDisplay.src = reader.result; // Update form logo preview
                        logoPreview.src = reader.result; // Update sidebar logo preview
                    };
                    reader.readAsDataURL(file);
                    // Clear the delete flag if a new logo is chosen
                    delete profileForm.dataset.deleteLogo; 
                }
            });

            // Handle logo deletion button
            deleteLogoBtn.addEventListener('click', () => {
                const placeholder = '../../images/placeholder.jpeg';
                logoDisplay.src = placeholder;
                logoPreview.src = placeholder;
                logoInput.value = ''; // Clear the file input
                // Set a flag to signal deletion on save
                profileForm.dataset.deleteLogo = 'true'; 
                showMessage('Logo marked for removal. Save changes to confirm.', false);
            });

            // Handle form submission
            profileForm.addEventListener('submit', async e => {
                e.preventDefault();
                
                 // Basic frontend validation
                if (!profileForm.checkValidity()) {
                    profileForm.reportValidity();
                    showMessage('Please fill in all required (*) fields.', true);
                    return;
                }
                
                saveButton.disabled = true;
                saveButton.textContent = 'Saving...';

                const formData = new FormData(profileForm);

                // Handle logo deletion flag
                if (profileForm.dataset.deleteLogo === 'true') {
                    // Send an empty string for the 'logo' field to signal deletion
                    formData.set('logo', ''); 
                } else if (!logoInput.files[0]) {
                     // If no new file is selected AND we are not deleting, remove 'logo'
                     // so PATCH doesn't try to clear it unintentionally.
                     formData.delete('logo');
                }
                // If a new file *is* selected, formData automatically includes it.

                try {
                    // Use PATCH for partial updates
                    const response = await apiFetch(apiURL, { method: 'PATCH', body: formData });

                    if (!response.ok) {
                         const errorData = await response.json();
                         let errorMsg = 'Save failed: ';
                         for (const key in errorData) {
                             errorMsg += `${key}: ${Array.isArray(errorData[key]) ? errorData[key].join(', ') : errorData[key]} `;
                         }
                         throw new Error(errorMsg.trim());
                    }

                    const data = await response.json(); // Get updated profile data from response

                    // Update UI and localStorage with the response data (source of truth)
                    const newLogoUrl = data.logo || '../../images/placeholder.jpeg';
                    logoDisplay.src = newLogoUrl;
                    logoPreview.src = newLogoUrl;
                    localStorage.setItem('companyLogo', newLogoUrl);

                    // Update company name in sidebar
                    profileNameEl.textContent = data.name || 'Employer';

                    showMessage('Profile updated successfully!');
                    delete profileForm.dataset.deleteLogo; // Clear deletion flag on success

                } catch(error) {
                     if (error.message !== 'Unauthorized' && error.message !== 'Network error during API fetch.') {
                         showMessage(`Error updating profile: ${error.message}`, true);
                     }
                    console.error("Profile save error:", error);
                } finally {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save Changes';
                }
            });

            // Logout button
            logoutBtn.addEventListener('click', e => {
                e.preventDefault();
                localStorage.clear(); // Clear all localStorage on logout
                window.location.href = '../../index.html';
            });

            // --- Initial Load ---
            loadProfileData(); // Fetch data from API on page load
        });
    </script>
</div>
</body>
</html>