<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CuroJobs - Company Profile</title>
    <link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/style.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/responsive.css" media="all">
</head>

<body>
<div class="main-page-wrapper">
    <aside class="dash-aside-navbar">
        <div class="position-relative">
            <div class="logo text-md-center">
                <a href="../../index.html"><img src="../../images/logo/logo_02.png" alt=""></a>
            </div>
            <div class="user-data">
                <div class="user-avatar online position-relative rounded-circle">
                    <img id="company-logo-preview" src="../../images/placeholder.jpeg" alt="">
                </div>
                <div class="user-name-data">
                    <button class="user-name dropdown-toggle" id="profile-dropdown">Loading...</button>
                </div>
            </div>
                <nav class="dasboard-main-nav">
                    <ul class="style-none">
                        <li><a href="employer-dashboard-index.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_1.svg" alt=""><span>Dashboard</span></a></li>
                        <li><a href="employer-dashboard-profile.html" class="d-flex w-100 align-items-center active"><img src="../../images/icon/icon_2.svg" alt=""><span>My Profile</span></a></li>
                        <li><a href="employer-dashboard-jobs.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_3_active.svg" alt=""><span>My Jobs</span></a></li>
                        <li><a href="employer-dashboard-message-setting.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_7.svg" alt=""><span>Msg Settings</span></a></li>
                        <li class="border-top pt-10 mt-10"><a href="../../index.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_8.svg" alt=""><span>Back to Home</span></a></li>
                        <li><a href="employer-dashboard-submit-job.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_39.svg" alt=""><span>Submit Job</span></a></li>
                        <li id="messages-nav-item" style="position: relative;">
                            <a href="employer-dashboard-message.html" class="d-flex w-100 align-items-center">
                                <img src="../../images/icon/icon_4.svg" alt=""><span>Messages</span>
                            </a>
                            <span class="notification-badge"></span>
                        </li>
                        <li><a href="#" id="logout-btn" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_9.svg" alt=""><span>Logout</span></a></li>
                    </ul>
                </nav>
        </div>
    </aside>

    <div class="dashboard-body">
        <div class="position-relative">
            <header class="dashboard-header"></header>
            <h2 class="main-title">Profile</h2>
            <div id="message-container" style="display:none;"></div>

            <form id="profile-form" enctype="multipart/form-data">
                <div class="bg-white card-box border-20">

                    <!-- âœ… Upload Company Logo -->
                    <div class="user-avatar-setting d-flex align-items-center mb-30">
                        <img id="company-logo-display" src="../../images/placeholder.jpeg" alt="" class="lazy-img user-img rounded-circle" style="width:80px;height:80px;object-fit:cover;">
                        <div class="upload-btn position-relative tran3s ms-4 me-3">
                            Upload Company Logo
                            <input type="file" id="logo" name="logo" accept="image/*">
                        </div>
                        <button type="button" id="delete-logo-btn" class="delete-btn tran3s">Delete</button>
                    </div>

                    <div class="dash-input-wrapper mb-30">
                        <label for="name">Company Name*</label>
                        <input type="text" id="name" name="name" placeholder="Your Company Name Inc.">
                    </div>
                    <div class="dash-input-wrapper mb-30">
                        <label for="website">Website*</label>
                        <input type="url" id="website" name="website" placeholder="https://yourcompany.com">
                    </div>
                    <div class="dash-input-wrapper">
                        <label for="description">About Company*</label>
                        <textarea id="description" name="description" class="size-lg" placeholder="Write something interesting about your company...."></textarea>
                    </div>
                </div>

                <div class="button-group d-inline-flex align-items-center mt-30">
                    <button type="submit" class="dash-btn-two tran3s me-3">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../../vendor/jwt-decode.js"></script>
    <script src="../../js/api.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const accessToken = localStorage.getItem('accessToken'); // Get token early
            if (!accessToken) { window.location.href = '../../login.html'; return; } // Redirect if no token

            let currentUser;
            try {
                currentUser = jwt_decode(accessToken);
                if (!currentUser || currentUser.user_type !== 'company') {
                    window.location.href = '../../login.html';
                    return;
                }
            } catch (e) {
                // Invalid token
                localStorage.clear();
                window.location.href = '../../login.html';
                return;
            }

            const apiURL = 'http://127.0.0.1:8000/api/v1/accounts/profile/company/';
            const profileForm = document.getElementById('profile-form');
            const profileNameEl = document.getElementById('profile-dropdown');
            const messageContainer = document.getElementById('message-container');
            const logoInput = document.getElementById('logo');
            const logoDisplay = document.getElementById('company-logo-display');
            const logoPreview = document.getElementById('company-logo-preview');
            const deleteLogoBtn = document.getElementById('delete-logo-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const saveButton = profileForm.querySelector('button[type="submit"]');

            // --- Define apiFetch locally ---
            const apiFetch = async (endpoint, options = {}) => {
                // Use the accessToken captured at the start
                const headers = options.body instanceof FormData
                    ? { 'Authorization': `Bearer ${accessToken}` }
                    : { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` };

                // Ensure method is correctly set, default to GET
                options.method = options.method || 'GET';

                try {
                    const response = await fetch(endpoint, { ...options, headers });
                    if (response.status === 401) { // Unauthorized
                        localStorage.clear();
                        window.location.href = '../../login.html';
                        // Throw an error to stop further processing in the calling function
                        throw new Error('Unauthorized');
                    }
                    return response;
                } catch (error) {
                    console.error("API Fetch Error:", error);
                    // Re-throw if it's an unauthorized error, otherwise handle locally
                    if (error.message === 'Unauthorized') throw error;
                    showMessage(`Network error: ${error.message}. Please check your connection.`, true);
                    // Throw a generic error to stop the calling function
                    throw new Error('Network error during API fetch.');
                }
            };


            const showMessage = (msg, isError = false) => {
                messageContainer.textContent = msg;
                messageContainer.className = `alert ${isError ? 'alert-danger' : 'alert-success'} mb-20`;
                messageContainer.style.display = 'block';
                window.scrollTo(0, 0);
                 setTimeout(() => { messageContainer.style.display = 'none'; }, 4000);
            };

            const loadProfileData = async () => {
                try {
                    const response = await apiFetch(apiURL); // Uses GET by default
                    if (!response.ok) throw new Error(`Could not load profile (${response.status})`);
                    const data = await response.json();

                    profileNameEl.textContent = data.name || 'Employer';
                    document.getElementById('name').value = data.name || '';
                    document.getElementById('description').value = data.description || '';
                    document.getElementById('website').value = data.website || '';

                    // **Source of truth is the API response**
                    const logoUrl = data.logo || '../../images/placeholder.jpeg';
                    logoDisplay.src = logoUrl;
                    logoPreview.src = logoUrl;
                    // Update localStorage *after* successful API fetch
                    localStorage.setItem('companyLogo', logoUrl);

                } catch(error) {
                    // Don't show generic message if it was an Unauthorized error handled by apiFetch
                    if (error.message !== 'Unauthorized' && error.message !== 'Network error during API fetch.') {
                         showMessage(`Could not load profile data: ${error.message}. Please refresh.`, true);
                    }
                    console.error("Profile load error:", error);
                     // Set defaults if load fails
                     profileNameEl.textContent = 'Employer';
                     const placeholder = '../../images/placeholder.jpeg';
                     logoDisplay.src = placeholder;
                     logoPreview.src = placeholder;
                }
            };

            // **Use localStorage ONLY for initial quick display**
            const savedLogo = localStorage.getItem('companyLogo');
            if (savedLogo) {
                logoPreview.src = savedLogo; // Update sidebar immediately
                // Don't set logoDisplay here, let loadProfileData handle it
            }


            // --- Event Listeners ---

            logoInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        logoDisplay.src = reader.result;
                        logoPreview.src = reader.result; // Update sidebar preview instantly
                    };
                    reader.readAsDataURL(file);
                     // Clear the delete flag if a new logo is chosen
                     delete profileForm.dataset.deleteLogo;
                }
            });

            deleteLogoBtn.addEventListener('click', () => {
                const placeholder = '../../images/placeholder.jpeg';
                logoDisplay.src = placeholder;
                logoPreview.src = placeholder;
                logoInput.value = ''; // Clear the file input
                // **Set a flag to signal deletion on save**
                profileForm.dataset.deleteLogo = 'true';
                showMessage('Logo marked for removal. Save changes to confirm.', false);
            });

            profileForm.addEventListener('submit', async e => {
                e.preventDefault();
                saveButton.disabled = true;
                saveButton.textContent = 'Saving...';

                const formData = new FormData(profileForm);

                // **Handle logo deletion flag**
                if (profileForm.dataset.deleteLogo === 'true') {
                    // Send null to indicate deletion (DRF handles null for ImageField)
                    formData.set('logo', ''); // Use set to ensure it overrides any file input value
                } else if (!logoInput.files[0]) {
                     // If no new file is selected AND we are not deleting,
                     // remove 'logo' from formData so PATCH doesn't try to clear it.
                     formData.delete('logo');
                }
                // If a new file *is* selected, formData automatically includes it.

                try {
                    // **Use PATCH**
                    const response = await apiFetch(apiURL, { method: 'PATCH', body: formData });

                    if (!response.ok) {
                         const errorData = await response.json();
                         let errorMsg = 'Save failed: ';
                         // Concatenate errors from the backend response
                         for (const key in errorData) {
                             if (Array.isArray(errorData[key])) {
                                 errorMsg += `${key}: ${errorData[key].join(', ')} `;
                             } else {
                                 errorMsg += `${key}: ${errorData[key]} `;
                             }
                         }
                         throw new Error(errorMsg);
                    }

                    const data = await response.json();

                    // Update UI and localStorage with the response data
                    const newLogoUrl = data.logo || '../../images/placeholder.jpeg';
                    logoDisplay.src = newLogoUrl;
                    logoPreview.src = newLogoUrl;
                    localStorage.setItem('companyLogo', newLogoUrl);

                    // Update company name in sidebar
                     profileNameEl.textContent = data.name || 'Employer';

                    showMessage('Profile updated successfully!');
                    delete profileForm.dataset.deleteLogo; // Clear deletion flag on success

                } catch(error) {
                    // Don't show generic message if it was an Unauthorized/Network error
                     if (error.message !== 'Unauthorized' && error.message !== 'Network error during API fetch.') {
                         showMessage(`Error updating profile: ${error.message}`, true);
                     }
                    console.error("Profile save error:", error);
                } finally {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save Changes';
                }
            });

            logoutBtn.addEventListener('click', e => {
                e.preventDefault();
                localStorage.clear(); // Clear all localStorage on logout
                window.location.href = '../../index.html';
            });

            // --- Initial Load ---
            loadProfileData(); // Fetch data from API as the primary source
        });
    </script>
</div>
</body>
</html>