<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CuroJobs - Submit Job</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="56x56" href="../../images/fav-icon/icon.png">
    <link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/style.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/responsive.css" media="all">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        /* TinyMCE container style */
        .tox-tinymce { border: 1px solid #dee2e6 !important; border-radius: 0.375rem !important; }
        .nice-select { line-height: normal; }
    </style>
        <style>
        /* --- Sidebar User Data Alignment --- */
        .dash-aside-navbar .user-data {
            display: flex;         /* Use flexbox for alignment */
            flex-direction: column; /* Stack items vertically */
            align-items: center;   /* Center items horizontally */
            text-align: center;    /* Center the text within the name container */
            margin-bottom: 20px;   /* Add some space below the name */
            padding-top: 15px;      /* Add some top padding */
        }

        .dash-aside-navbar .user-avatar {
            width: 60px;          /* Set a specific size for the logo container */
            height: 60px;
            margin-bottom: 10px;   /* Add space between logo and name */
        }
        
        /* Ensure image fills the circle */
        .dash-aside-navbar .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .dash-aside-navbar .user-name-data {
            margin-top: 0;         /* Remove default top margin if any */
        }

        .dash-aside-navbar .user-name {
            font-size: 16px;       /* Adjust font size as needed */
            font-weight: 500;
            color: #333;          /* Adjust text color if needed */
        }
        
        /* Ensure placeholder fits */
         #company-logo-preview {
             width: 100%; 
             height: 100%; 
             object-fit: cover;
         }
    </style>
</head>

<body>
    <div class="main-page-wrapper">
        <div id="preloader">
            <div id="ctn-preloader" class="ctn-preloader">
                <div class="icon"><img src="../../images/loader.svg" alt="" class="m-auto d-block" width="60"></div>
                <div class="txt-loading">
                    <span data-text-preloader="C" class="letters-loading">C</span>
                    <span data-text-preloader="U" class="letters-loading">U</span>
                    <span data-text-preloader="R" class="letters-loading">R</span>
                    <span data-text-preloader="O" class="letters-loading">O</span>
                    <span data-text-preloader="J" class="letters-loading">J</span>
                    <span data-text-preloader="O" class="letters-loading">O</span>
                    <span data-text-preloader="B" class="letters-loading">B</span>
                    <span data-text-preloader="S" class="letters-loading">S</span>
                </div>
            </div>
        </div>

        <aside class="dash-aside-navbar">
            <div class="position-relative">
                <div class="logo text-md-center d-flex align-items-center justify-content-between">
                    <a href="../../index.html"><img src="../../images/logo/logo_02.png" alt="" class="curo"></a>
                    <button class="close-btn d-block d-md-none"><i class="bi bi-x-lg"></i></button>
                </div>
                <div class="user-data">
                    <div class="user-avatar online position-relative rounded-circle">
                         <img id="company-logo-preview" src="../../images/placeholder.jpeg" alt="" class="lazy-img">
                    </div>
                    <div class="user-name-data">
                        <div class="user-name" id="profile-dropdown">Loading...</div>
                    </div>
                </div>
                <nav class="dasboard-main-nav">
                    <ul class="style-none">
                        <li><a href="employer-dashboard-index.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_1.svg" alt=""><span>Dashboard</span></a></li>
                        <li><a href="employer-dashboard-profile.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_2.svg" alt=""><span>My Profile</span></a></li>
                        <li><a href="employer-dashboard-jobs.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_3.svg" alt=""><span>My Jobs</span></a></li>
                        <li><a href="employer-dashboard-submit-job.html" class="d-flex w-100 align-items-center active"><img src="../../images/icon/icon_39_active.svg" alt=""><span>Submit Job</span></a></li>
                        <li><a href="employer-dashboard-message.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_4.svg" alt=""><span>Messages</span></a></li>
                        <li><a href="employer-dashboard-message-settings.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_7.svg" alt=""><span>Msg Settings</span></a></li>
                        <li><a href="../../index.html" class="d-flex w-100 align-items-center mt-10 pt-10"><img src="../../images/icon/icon_30 copy.svg" alt=""><span>Back to Home</span></a></li>
                        <li><a href="#" id="logout-btn" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_9.svg" alt=""><span>Logout</span></a></li>
                    </ul>
                </nav>
            </div>
        </aside>

        <div class="dashboard-body">
            <div class="position-relative">
                <header class="dashboard-header">
                    <div class="d-flex align-items-center justify-content-end">
                        <button class="dash-mobile-nav-toggler d-block d-md-none me-auto"><span></span></button>
                    </div>
                </header>
                <h2 class="main-title" id="page-title">Post a New Job</h2>
                <div id="message-container" class="alert" style="display: none;"></div>

                <div class="bg-white card-box border-20">
                    <h4 class="dash-title-three">Job Details</h4>
                    <form id="submit-job-form">
                        <div class="dash-input-wrapper mb-30">
                            <label for="title">Job Title*</label>
                            <input type="text" id="title" name="title" placeholder="Ex: Certified Nursing Assistant (CNA)" required>
                        </div>

                        <div class="dash-input-wrapper mb-30">
                            <label for="description">Job Description*</label>
                            <!-- required removed; TinyMCE will manage content and custom JS validates it -->
                            <textarea id="description" name="description" class="size-lg" placeholder="Write about the job in detail..."></textarea>
                        </div>

                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <div class="dash-input-wrapper mb-30">
                                    <label for="job_type">Job Type*</label>
                                    <select id="job_type" name="job_type" class="nice-select" required>
                                        <option value="">Select Job Type...</option>
                                        <option value="Full-Time">Full-Time</option>
                                        <option value="Part-Time">Part-Time</option>
                                        <option value="Weekends">Weekends</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="dash-input-wrapper mb-30">
                                    <label for="salary">Salary Range*</label>
                                    <input type="text" id="salary" name="salary" placeholder="e.g., $25 - $35 / hour OR $50k - $60k Annually" required>
                                </div>
                            </div>
                        </div>

                        <h4 class="dash-title-three pt-50 lg-pt-30">Location</h4>

                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <div class="dash-input-wrapper mb-30">
                                    <label for="country">Country*</label>
                                    <select id="country" name="country" class="form-select" required>
                                        <option value="US" selected>United States</option>
                                    </select>
                                </div>
                            </div>

                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <div class="dash-input-wrapper mb-30">
                                    <label for="state">State*</label>
                                    <select id="state" name="state" class="form-select" required>
                                        <option value="">Select State</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="dash-input-wrapper mb-30">
                                    <label for="city">City*</label>
                                    <select id="city" name="city" class="form-select" required disabled>
                                        <option value="">Select State First</option>
                                    </select>
                                </div>
                            </div>
                             <div class="col-md-12">
                                <div class="dash-input-wrapper mb-30">
                                    <label for="location">Specific Location/Area (Optional)</label>
                                    <input type="text" id="location" name="location" placeholder="e.g., Downtown Dallas Office, Remote within Texas">
                                     <div class="form-text">Provide specific area if State/City isn't enough.</div>
                                </div>
                            </div>
                        </div>

                        <h4 class="dash-title-three pt-50 lg-pt-30">Additional Details</h4>
                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <div class="dash-input-wrapper mb-30">
                                    <label for="category">Job Category*</label>
                                    <select id="category" name="category" class="nice-select" required>
                                        <option value="">Select Category...</option>
                                        <option value="Hospitals/Clinics">Hospitals/Clinics</option>
                                        <option value="Home Health/Hospice">Home Health/Hospice</option>
                                        <option value="Behavioral/Mental Health Services">Behavioral/Mental Health</option>
                                        <option value="Assisted Living/Long-Term Care">Assisted Living/LTC</option>
                                        <option value="Social Work/Human Services">Social Work/Human Services</option>
                                        <option value="Telehealth/Virtual Care">Telehealth/Virtual Care</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="dash-input-wrapper mb-30">
                                    <label for="language">Language Required</label>
                                    <select id="language" name="language" class="nice-select">
                                         <option value="">Not Specified</option>
                                         <option value="English">English</option>
                                         <option value="Spanish">Spanish</option>
                                         <option value="Bilingual">Bilingual (Specify in description)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="dash-input-wrapper mb-30">
                                    <label for="contract_type">Contract Type*</label>
                                    <select id="contract_type" name="contract_type" class="nice-select" required>
                                        <option value="">Select Contract Type...</option>
                                        <option value="Permanent">Permanent</option>
                                        <option value="Contract">Contract</option>
                                        <option value="Internship">Internship</option>
                                    </select>
                                </div>
                            </div>
                             <div class="col-md-6">
                                <div class="dash-input-wrapper mb-30">
                                    <label for="work_mode">Work Mode*</label>
                                    <select id="work_mode" name="work_mode" class="nice-select" required>
                                        <option value="">Select Work Mode...</option>
                                        <option value="In-Person">In-Person</option>
                                        <option value="Hybrid">Hybrid</option>
                                        <option value="Remote">Remote</option>
                                    </select>
                                </div>
                            </div>
                             <div class="col-md-12">
                                <div class="dash-input-wrapper mb-30">
                                    <label for="vsiq_required">Voluntary Self-Identification Questions (VSIQ)*</label>
                                    <select id="vsiq_required" name="vsiq_required" class="nice-select" required>
                                        <option value="None">None (Do not ask)</option>
                                        <option value="GenderEthnicity">Ask Gender & Ethnicity</option>
                                        <option value="All">Ask All (Gender, Ethnicity, Veteran, Disability)</option>
                                    </select>
                                     <div class="form-text">Choose which set of voluntary questions applicants should see (used for EEO reporting).</div>
                                </div>
                            </div>
                        </div>

                        <div class="button-group d-inline-flex align-items-center mt-30">
                            <button type="submit" class="dash-btn-two tran3s me-3" id="submit-button">Post Job</button>
                            <a href="employer-dashboard-jobs.html" class="dash-cancel-btn tran3s">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script src="https://cdn.tiny.cloud/1/qe719wtnsho7jlw9hkinqx7v1a2vyymm79azptl0g1eawj6u/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>

        <script src="../../vendor/jquery.min.js"></script>
        <script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="../../vendor/wow/wow.min.js"></script>
        <script src="../../vendor/jquery.lazy.min.js"></script>
        <script src="../../vendor/nice-select/jquery.nice-select.min.js"></script>
        <script src="../../vendor/jwt-decode.js"></script>
        <script src="../../js/theme.js"></script>

        <script>
            // --- US States List ---
            const US_STATES = [
                 { name: 'Alabama', abbr: 'AL' }, { name: 'Alaska', abbr: 'AK' }, { name: 'Arizona', abbr: 'AZ' },
                 { name: 'Arkansas', abbr: 'AR' }, { name: 'California', abbr: 'CA' }, { name: 'Colorado', abbr: 'CO' },
                 { name: 'Connecticut', abbr: 'CT' }, { name: 'Delaware', abbr: 'DE' }, { name: 'Florida', abbr: 'FL' },
                 { name: 'Georgia', abbr: 'GA' }, { name: 'Hawaii', abbr: 'HI' }, { name: 'Idaho', abbr: 'ID' },
                 { name: 'Illinois', abbr: 'IL' }, { name: 'Indiana', abbr: 'IN' }, { name: 'Iowa', abbr: 'IA' },
                 { name: 'Kansas', abbr: 'KS' }, { name: 'Kentucky', abbr: 'KY' }, { name: 'Louisiana', abbr: 'LA' },
                 { name: 'Maine', abbr: 'ME' }, { name: 'Maryland', abbr: 'MD' }, { name: 'Massachusetts', abbr: 'MA' },
                 { name: 'Michigan', abbr: 'MI' }, { name: 'Minnesota', abbr: 'MN' }, { name: 'Mississippi', abbr: 'MS' },
                 { name: 'Missouri', abbr: 'MO' }, { name: 'Montana', abbr: 'MT' }, { name: 'Nebraska', abbr: 'NE' },
                 { name: 'Nevada', abbr: 'NV' }, { name: 'New Hampshire', abbr: 'NH' }, { name: 'New Jersey', abbr: 'NJ' },
                 { name: 'New Mexico', abbr: 'NM' }, { name: 'New York', abbr: 'NY' }, { name: 'North Carolina', abbr: 'NC' },
                 { name: 'North Dakota', abbr: 'ND' }, { name: 'Ohio', abbr: 'OH' }, { name: 'Oklahoma', abbr: 'OK' },
                 { name: 'Oregon', abbr: 'OR' }, { name: 'Pennsylvania', abbr: 'PA' }, { name: 'Rhode Island', abbr: 'RI' },
                 { name: 'South Carolina', abbr: 'SC' }, { name: 'South Dakota', abbr: 'SD' }, { name: 'Tennessee', abbr: 'TN' },
                 { name: 'Texas', abbr: 'TX' }, { name: 'Utah', abbr: 'UT' }, { name: 'Vermont', abbr: 'VT' },
                 { name: 'Virginia', abbr: 'VA' }, { name: 'Washington', abbr: 'WA' }, { name: 'West Virginia', abbr: 'WV' },
                 { name: 'Wisconsin', abbr: 'WI' }, { name: 'Wyoming', abbr: 'WY' },
            ];

            document.addEventListener('DOMContentLoaded', () => {
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) { window.location.href = '../../login.html'; return; }
                try {
                    const decodedToken = jwt_decode(accessToken);
                    if (decodedToken.user_type !== 'company') { window.location.href = '../../index.html'; return; }
                } catch (e) {
                    localStorage.clear();
                    window.location.href = '../../login.html';
                    return;
                }

                // --- Elements ---
                const submitJobForm = document.getElementById('submit-job-form');
                const messageContainer = document.getElementById('message-container');
                const pageTitle = document.getElementById('page-title');
                const submitButton = document.getElementById('submit-button');
                const profileNameEl = document.getElementById('profile-dropdown');
                const logoutBtn = document.getElementById('logout-btn');
                const stateSelect = document.getElementById('state');
                const citySelect = document.getElementById('city');
                const logoPreview = document.getElementById('company-logo-preview');
                const descriptionTextarea = document.getElementById('description');

                // --- API Endpoints ---
                const BASE_API_URL = 'http://127.0.0.1:8000/api/v1/';
                const JOBS_API_URL = `${BASE_API_URL}jobs/`;
                const ACCOUNTS_API_URL = `${BASE_API_URL}accounts/`;
                const LOCATION_API_URL = `${ACCOUNTS_API_URL}locations/cities/`;

                // --- Edit Mode ---
                const params = new URLSearchParams(window.location.search);
                const jobId = params.get('edit');
                const isEditMode = jobId !== null;

                // --- Initialize TinyMCE ---
                 let isTinyMceInitialized = false;
                 tinymce.init({
                     selector: '#description',
                     plugins: [
                       'anchor', 'autolink', 'charmap', 'codesample', 'emoticons', 'link', 'lists', 'media', 'searchreplace', 'table', 'visualblocks', 'wordcount',
                       'checklist', 'mediaembed', 'formatpainter', 'powerpaste', 'advtable', 'typography', 'inlinecss'
                     ],
                     toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link media table | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat',
                     height: 350,
                     menubar: false,
                     setup: function (editor) {
                         editor.on('init', function () {
                             console.log("TinyMCE initialized.");
                             isTinyMceInitialized = true;
                             if (isEditMode) {
                                 populateFormForEdit();
                             }
                         });
                     }
                 });

                // --- Helper Functions ---
                 const apiFetch = async (endpoint, options = {}) => {
                     const headers = {
                         'Content-Type': 'application/json',
                         'Authorization': `Bearer ${accessToken}`
                     };
                     if (options.body instanceof FormData) { delete headers['Content-Type']; }

                     try {
                         const response = await fetch(endpoint, { ...options, headers });
                         if (response.status === 401) {
                             localStorage.clear();
                             window.location.href = '../../login.html';
                             throw new Error('Unauthorized');
                         }
                         return response;
                     } catch(error) {
                         console.error("API Fetch Error:", error);
                         if (error.message === 'Unauthorized') throw error;
                         showMessage(`Network error: ${error.message}. Please check connection.`, true);
                         throw new Error('Network error during API fetch.');
                     }
                };

                const showMessage = (message, isError = false) => {
                    messageContainer.innerHTML = message;
                    messageContainer.className = `alert ${isError ? 'alert-danger' : 'alert-success'} mb-20`;
                    messageContainer.style.display = 'block';
                     setTimeout(() => { messageContainer.style.display = 'none'; }, 4000);
                };

                const populateStates = (selectedStateAbbr = null) => {
                    stateSelect.innerHTML = '<option value="">Select State</option>';
                    US_STATES.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state.abbr;
                        option.textContent = state.name;
                        if (selectedStateAbbr && state.abbr === selectedStateAbbr) option.selected = true;
                        stateSelect.appendChild(option);
                    });
                    $(stateSelect).niceSelect('update');
                    stateSelect.disabled = false;
                };

                const fetchCities = async (stateCode, selectedCityName = null) => {
                     citySelect.innerHTML = '<option value="">Loading Cities...</option>';
                     citySelect.disabled = true;
                     $(citySelect).niceSelect('update');

                     if (!stateCode) {
                         citySelect.innerHTML = '<option value="">Select State First</option>';
                         $(citySelect).niceSelect('update');
                         return;
                     }

                     try {
                         const response = await apiFetch(`${LOCATION_API_URL}?state_code=${stateCode}`);
                         if (!response.ok) throw new Error('Failed to fetch cities');
                         const data = await response.json();

                         citySelect.innerHTML = '<option value="">Select City</option>';
                         data.forEach(city => {
                             const option = document.createElement('option');
                             option.value = city.name;
                             option.textContent = city.name;
                             if (selectedCityName && city.name === selectedCityName) option.selected = true;
                             citySelect.appendChild(option);
                         });
                         citySelect.disabled = false;
                         $(citySelect).niceSelect('update');

                     } catch (error) {
                         citySelect.innerHTML = '<option value="">Error Loading Cities</option>';
                         console.error('Error fetching cities:', error);
                         $(citySelect).niceSelect('update');
                     }
                };

                 // --- Profile Loading for Sidebar ---
                 const fetchProfile = async () => {
                     try {
                        const response = await apiFetch(`${ACCOUNTS_API_URL}profile/company/`);
                        if (!response.ok) return;
                        const profile = await response.json();
                        profileNameEl.textContent = profile.name || 'Employer';
                        const logoUrl = profile.logo || '../../images/placeholder.jpeg';
                        logoPreview.src = logoUrl;
                        localStorage.setItem('companyLogo', logoUrl);
                    } catch (error) {
                         console.error("Sidebar Profile Error:", error);
                         profileNameEl.textContent = 'Employer';
                    }
                 };
                 const savedLogo = localStorage.getItem('companyLogo');
                 if (savedLogo) logoPreview.src = savedLogo;

                // --- Form Population (Edit Mode) ---
                const populateFormForEdit = async () => {
                     if (!isTinyMceInitialized) return;
                     console.log("Populating form for edit...");

                    pageTitle.textContent = 'Edit Job';
                    submitButton.textContent = 'Save Changes';
                    try {
                        const response = await apiFetch(`${JOBS_API_URL}${jobId}/`);
                        if (!response.ok) throw new Error(`Job not found (${response.status})`);
                        const job = await response.json();

                        document.getElementById('title').value = job.title;

                        // TinyMCE content load
                        const editorInstance = tinymce.get('description');
                        if (editorInstance) editorInstance.setContent(job.description || '');

                        $('#job_type').val(job.job_type).niceSelect('update');
                        $('#salary').val(job.salary || '');

                        const jobStateAbbr = job.state;
                        if (jobStateAbbr) {
                            populateStates(jobStateAbbr);
                            const jobCityName = job.city;
                            await fetchCities(jobStateAbbr, jobCityName);
                        } else {
                             populateStates();
                        }

                        $('#location').val(job.location || '');
                        $('#category').val(job.category || '').niceSelect('update');
                        $('#language').val(job.language || '').niceSelect('update');
                        $('#contract_type').val(job.contract_type || '').niceSelect('update');
                        $('#work_mode').val(job.work_mode || '').niceSelect('update');
                        $('#vsiq_required').val(job.vsiq_required || 'None').niceSelect('update');

                    } catch (error) {
                        showMessage(`Could not load job data for editing: ${error.message}`, true);
                        submitJobForm.style.display = 'none';
                    }
                };

                // --- Form Submission ---
                submitJobForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // Ensure TinyMCE updates the textarea (keeps content in sync if you still read textarea)
                    tinymce.triggerSave();

                    // Custom TinyMCE content validation (avoid hidden textarea focus issue)
                    const editor = tinymce.get('description');
                    const descriptionText = editor ? editor.getContent({ format: 'text' }).trim() : descriptionTextarea.value.trim();
                    if (!descriptionText) {
                        showMessage('Job Description cannot be empty.', true);
                        return;
                    }

                    // Validate native constraints for other fields
                    if (!submitJobForm.checkValidity()) {
                         submitJobForm.reportValidity();
                         showMessage('Please fill in all required (*) fields.', true);
                         return;
                    }

                    submitButton.disabled = true;
                    submitButton.textContent = isEditMode ? 'Updating...' : 'Posting...';

                    try {
                        const formData = new FormData(submitJobForm);
                        const data = Object.fromEntries(formData.entries());

                        data.location = data.location_specific || `${data.city || ''}, ${data.state || ''}, United States`;
                        delete data.location_specific;


                        if (!data.location || !data.location.trim()) {
                            showMessage('Job location is required.', true);
                            submitButton.disabled = false;
                            submitButton.textContent = isEditMode ? 'Save Changes' : 'Post Job';
                            return;
                        }


                        // âœ… Fix: convert empty strings to null for optional fields
                        for (const key in data) {
                        if (data[key] === '') data[key] = null;
                        }


                        const method = isEditMode ? 'PATCH' : 'POST';
                        const url = isEditMode ? `${JOBS_API_URL}${jobId}/` : JOBS_API_URL;

                        const response = await apiFetch(url, {
                            method: method,
                            body: JSON.stringify(data)
                        });

                        if (!response.ok) {
                            const result = await response.json();
                             let errorMsg = `Error ${isEditMode ? 'updating' : 'posting'} job:<br>`;
                             for (const key in result) {
                                if (Array.isArray(result[key])) {
                                     errorMsg += `&bull; ${key}: ${result[key].join(', ')}<br>`;
                                 } else {
                                     errorMsg += `&bull; ${key}: ${result[key]}<br>`;
                                 }
                             }
                             throw new Error(errorMsg);
                        }

                        showMessage(`Job ${isEditMode ? 'updated' : 'posted'} successfully! Redirecting...`, false);
                        setTimeout(() => {
                            window.location.href = 'employer-dashboard-jobs.html';
                        }, 2000);

                    } catch (error) {
                         if (error.message !== 'Unauthorized' && error.message !== 'Network error during API fetch.') {
                              showMessage(error.message, true);
                         }
                        console.error("Submit Error:", error);
                        submitButton.disabled = false;
                        submitButton.textContent = isEditMode ? 'Save Changes' : 'Post Job';
                    }
                });

                // --- Event Listeners ---
                stateSelect.addEventListener('change', (e) => fetchCities(e.target.value));

                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.clear();
                    window.location.href = '../../index.html';
                });

                // --- Initial Load ---
                const initializePage = async () => {
                     populateStates();
                     $('select.nice-select').niceSelect();
                     await fetchProfile();
                     if (!isEditMode) {
                        console.log("Create mode: TinyMCE will initialize.");
                     }
                };

                initializePage();
            });
        </script>
    </div>
</body>
</html>
