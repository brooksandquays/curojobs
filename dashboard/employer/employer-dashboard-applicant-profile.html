<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CuroJobs - Applicant Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="56x56" href="../../images/fav-icon/icon.png">

    <link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/style.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/responsive.css" media="all">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" type="text/css" href="../../vendor/nice-select/nice-select.css">

    <style>
        .notification-badge {
            position: absolute; top: 15px; right: 25px; height: 10px; width: 10px;
            background-color: #dc3545; border-radius: 50%; border: 2px solid white; display: none;
        }

        /* --- Sidebar User Data Alignment --- */
        .dash-aside-navbar .user-data { display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 20px; padding-top: 15px; }
        .dash-aside-navbar .user-avatar { width: 60px; height: 60px; margin-bottom: 10px; overflow: hidden; border-radius: 50%; }
        .dash-aside-navbar .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .dash-aside-navbar .user-name-data { margin-top: 0; }
        .dash-aside-navbar .user-name { font-size: 16px; font-weight: 500; color: #333; }
        #company-logo-preview { width: 100%; height: 100%; object-fit: cover; }

         /* --- Applicant Profile Specific Styles --- */
        .candidate-profile-card .cadidate-avatar {
             background-color: #f0f5ff; width: 80px; height: 80px; border-radius: 50%;
             font-size: 40px; font-weight: 500; color: #4866a6; display: flex; align-items: center; justify-content: center;
        }
        .candidate-profile-card .name { font-size: 1.25rem; font-weight: 500;}
        .candidate-profile-card .candidate-post { font-size: 0.9rem; color: #555; margin-bottom: 1rem;}
        .candidate-profile-card .candidate-info li { margin-bottom: 0.5rem; font-size: 0.9rem; }
        .candidate-profile-card .candidate-info li span { font-weight: 500; color: #333; min-width: 80px; display: inline-block;}
        .time-line-data { border-left: 1px solid #e8e8e8; padding-left: 20px; margin-left: 5px; }
        .time-line-data::before {
            content: ''; position: absolute; left: -5.5px; top: 5px; width: 10px; height: 10px;
            border-radius: 50%; background-color: #244034; border: 2px solid white;
        }
        .time-line-data .info span { font-size: 0.9em; color: #555;}
        .time-line-data .info p { font-size: 0.85em; color: #777; margin-bottom: 15px;}
        .dash-title-three { font-size: 1.1rem; font-weight: 500; margin-bottom: 1rem;}

    </style>
</head>

<body>
    <div class="main-page-wrapper">
        <div id="preloader"><div id="ctn-preloader" class="ctn-preloader"><div class="icon"><img src="../../images/loader.svg" alt="" class="m-auto d-block" width="60"></div></div></div>

        <aside class="dash-aside-navbar">
            <div class="position-relative">
                <div class="logo text-md-center d-flex align-items-center justify-content-between">
                    <a href="../../index.html"><img src="../../images/logo/logo_02.png" alt="" class="curo"></a>
                    <button class="close-btn d-block d-md-none"><i class="bi bi-x-lg"></i></button>
                </div>
                <div class="user-data">
                    <div class="user-avatar online position-relative rounded-circle">
                         <img id="company-logo-preview" src="../../images/placeholder.jpeg" alt="Company Logo"> {/* Removed lazy-img class just in case */}
                    </div>
                    <div class="user-name-data">
                        <div class="user-name" id="profile-dropdown">Loading...</div>
                    </div>
                </div>
                <nav class="dasboard-main-nav">
                    <ul class="style-none">
                        <li><a href="employer-dashboard-index.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_1.svg" alt=""><span>Dashboard</span></a></li>
                        <li><a href="employer-dashboard-profile.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_2.svg" alt=""><span>My Profile</span></a></li>
                        <li><a href="employer-dashboard-jobs.html" class="d-flex w-100 align-items-center active"><img src="../../images/icon/icon_3_active.svg" alt=""><span>My Jobs</span></a></li> 
                        <li><a href="employer-dashboard-submit-job.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_39 copy.svg" alt=""><span>Submit Job</span></a></li>
                        <li id="messages-nav-item" style="position: relative;">
                            <a href="employer-dashboard-message.html" class="d-flex w-100 align-items-center">
                                <img src="../../images/icon/icon_4.svg" alt=""><span>Messages</span>
                            </a>
                            <span class="notification-badge" style="display: none;"></span>
                        </li>
                        <li><a href="employer-dashboard-message-setting.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_7.svg" alt=""><span>Msg Settings</span></a></li>
                        <li><a href="../../index.html" class="d-flex w-100 align-items-center mt-10 pt-10"><img src="../../images/icon/icon_30 copy.svg" alt=""><span>Back to Home</span></a></li>
                        <li><a href="#" id="logout-btn" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_9.svg" alt=""><span>Logout</span></a></li>
                    </ul>
                </nav>
            </div>
        </aside>
        <div class="dashboard-body">
            <div class="position-relative">
                <header class="dashboard-header">
                     <div class="d-flex align-items-center justify-content-end">
                       <button class="dash-mobile-nav-toggler d-block d-md-none me-auto"><span></span></button>
                    </div>
                </header>
                <h2 class="main-title">Applicant Profile</h2>

                <div id="message-container" class="alert mt-3 mb-3" style="display: none;"></div>

                <div class="bg-white card-box border-20">
                    <div id="profile-container" class="row p-4 p-md-5">
                        <div class="col-12"><div class="text-center p-5"><h4>Loading applicant profile...</h4></div></div>
                    </div>
                </div>
            </div>
        </div>

        <script src="../../vendor/jquery.min.js"></script>
        <script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="../../vendor/wow/wow.min.js"></script>
        <script src="../../vendor/jquery.lazy.min.js"></script>
        <script src="../../vendor/nice-select/jquery.nice-select.min.js"></script>
        <script src="../../vendor/jwt-decode.js"></script>
        <script src="../../js/theme.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // --- 1. AUTH & CONFIG ---
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) { window.location.href = '../../login.html'; return; }
                let currentUser;
                try { currentUser = jwt_decode(accessToken); if (currentUser.user_type !== 'company') { window.location.href = '../../index.html'; return; } }
                catch (e) { localStorage.clear(); window.location.href = '../../login.html'; return; }

                const params = new URLSearchParams(window.location.search);
                const applicantId = params.get('applicantId');

                // --- 2. ELEMENTS ---
                const profileContainer = document.getElementById('profile-container');
                const profileNameEl = document.getElementById('profile-dropdown');
                const logoPreview = document.getElementById('company-logo-preview'); // Correct ID is targeted
                const logoutBtn = document.getElementById('logout-btn');
                const messageContainer = document.getElementById('message-container');
                const baseApiURL = 'http://127.0.0.1:8000/api/v1/';

                if (!applicantId) {
                    profileContainer.innerHTML = '<div class="col-12 p-5 text-center text-danger"><h3>Error: Applicant ID is missing.</h3></div>';
                    return;
                }

                // --- 3. UTILITIES ---
                const apiFetch = async (endpoint, options = {}) => {
                    const headers = options.body instanceof FormData ? { 'Authorization': `Bearer ${accessToken}` } : { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` };
                    const response = await fetch(`${baseApiURL}${endpoint}`, { ...options, headers });
                     if(response.status === 401) { localStorage.clear(); window.location.href = '../../login.html'; throw new Error('Unauthorized'); }
                    return response;
                };
                 const showMessage = (message, isError = false) => {
                    messageContainer.textContent = message; messageContainer.className = `alert ${isError ? 'alert-danger' : 'alert-success'} mb-3`; messageContainer.style.display = 'block'; window.scrollTo({ top: 0, behavior: 'smooth' }); setTimeout(() => { messageContainer.style.display = 'none'; }, 4000);
                 };
                 const checkUnreadMessages = async () => {
                    try { const response = await apiFetch('accounts/messages/unread-count/'); if (!response.ok) return; const data = await response.json(); const badge = document.querySelector('#messages-nav-item .notification-badge'); if (badge) badge.style.display = data.unread_count > 0 ? 'block' : 'none'; } catch (error) { console.warn("Could not check for unread messages.", error); }
                 };

                // --- 4. fetchProfile (Sidebar) ---
                const fetchProfile = async () => {
                    // Instantly set logo from localStorage if available
                    const savedLogo = localStorage.getItem('companyLogo');
                    if (savedLogo && logoPreview) {
                        logoPreview.src = savedLogo;
                    } else if (logoPreview) {
                        logoPreview.src = '../../images/placeholder.jpeg'; // Fallback
                    }
                    // Fetch profile from API for latest data
                    try {
                        const response = await apiFetch('accounts/profile/company/');
                        if (!response.ok) throw new Error('Failed to fetch profile');
                        const profile = await response.json();

                        if (profileNameEl) {
                            profileNameEl.textContent = profile.name || 'Employer';
                        }
                        const logoUrl = profile.logo || '../../images/placeholder.jpeg';
                        if (logoPreview) {
                            logoPreview.src = logoUrl; // Update with API data
                        }
                        localStorage.setItem('companyLogo', logoUrl); // Sync localStorage
                    } catch (error) {
                         console.error("Error fetching sidebar profile:", error);
                         // Keep potentially stale localStorage data, update name only
                         if (profileNameEl) {
                            profileNameEl.textContent = 'Employer';
                         }
                    }
                };

                // --- 5. fetchApplicantProfile (Main Content) ---
                const fetchApplicantProfile = async () => {
                    profileContainer.innerHTML = '<div class="col-12"><div class="text-center p-5"><h4>Loading applicant profile...</h4></div></div>';
                    try {
                        const response = await apiFetch(`accounts/applicants/${applicantId}/`);
                        if (!response.ok) { let errorMsg = 'Applicant profile not found or permission denied.'; try { const errData = await response.json(); errorMsg = errData.detail || errorMsg;} catch {} throw new Error(errorMsg); }
                        const applicant = await response.json();

                        const educationHtml = applicant.education?.length > 0 ? applicant.education.map(edu => `<div class="time-line-data position-relative"><div class="info"><h6 class="mb-0">${edu?.title ?? 'N/A'}</h6><span>${edu?.academy ?? 'N/A'}</span><p>${edu?.start_year ?? '?'} - ${edu?.end_year ?? '?'}</p></div></div>`).join('') : '<p>No education history provided.</p>';
                        const experienceHtml = applicant.experience?.length > 0 ? applicant.experience.map(exp => `<div class="time-line-data position-relative"><div class="info"><h6 class="mb-0">${exp?.title ?? 'N/A'}</h6><span>${exp?.company ?? 'N/A'}</span><p>${exp?.start_year ?? '?'} - ${exp?.end_year ?? 'Present'}</p></div></div>`).join('') : '<p>No work experience provided.</p>';
                        const applicantInitial = applicant.full_name?.charAt(0).toUpperCase() ?? applicant.username?.charAt(0).toUpperCase() ?? '?';
                        const applicantEmail = applicant.email ?? 'Not Provided';
                        const applicantCV = applicant.cv;
                        const applicantUserId = applicant.user_id;
                        const locationDisplay = (applicant.city && applicant.state) ? `${applicant.city}, ${applicant.state}` : (applicant.state ?? applicant.city ?? 'Not specified');

                        profileContainer.innerHTML = `
                            <div class="col-lg-8">
                                <div class="dash-input-wrapper mb-40"><h6 class="dash-title-three">About Me</h6><p>${applicant.bio || 'No bio provided.'}</p></div>
                                <div class="border-top mt-40 pt-40"><h4 class="dash-title-three">Education</h4>${educationHtml}</div>
                                <div class="border-top mt-40 pt-40"><h4 class="dash-title-three">Work Experience</h4>${experienceHtml}</div>
                            </div>
                            <div class="col-lg-4">
                                <div class="candidate-profile-card ms-lg-5 lg-mt-40">
                                    <div class="cadidate-avatar online position-relative d-flex align-items-center justify-content-center m-auto">${applicantInitial}</div>
                                    <h4 class="name text-center mt-20">${applicant.full_name || applicant.username}</h4>
                                    <div class="candidate-post text-center">${applicant.job_title || 'Not specified'}</div>
                                    <ul class="style-none candidate-info mt-25">
                                        <li><span>Location:</span> ${locationDisplay}</li>
                                        <li><span>Email:</span> <a href="mailto:${applicantEmail}">${applicantEmail}</a></li>
                                        ${applicant.phone_number ? `<li><span>Phone:</span> ${applicant.phone_number}</li>` : ''}
                                    </ul>
                                    ${applicantCV ? `<a href="${applicantCV}" target="_blank" class="btn-one w-100 mt-25 tran3s">Download CV</a>` : '<p class="text-center text-muted mt-25">No CV Uploaded</p>'}
                                    <a href="employer-dashboard-message.html?recipientId=${applicantUserId}&recipientName=${encodeURIComponent(applicant.full_name || applicant.username)}" class="btn-ten w-100 mt-20 tran3s">Send Message</a>
                                </div>
                            </div>
                        `;
                    } catch (error) { console.error("Fetch Applicant Error:", error); showMessage(`Error loading profile: ${error.message}`, true); profileContainer.innerHTML = `<div class="col-12 p-5 text-center text-danger"><h3>Error</h3><p>${error.message}</p></div>`; }
                };

                // --- 6. EVENT LISTENERS ---
                if (logoutBtn) { logoutBtn.addEventListener('click', (e) => { e.preventDefault(); localStorage.clear(); window.location.href = '../../index.html'; }); }

                // --- 7. INITIAL LOAD ---
                fetchProfile();
                fetchApplicantProfile();
                checkUnreadMessages();

            });
        </script>
    </div>
</body>
</html>