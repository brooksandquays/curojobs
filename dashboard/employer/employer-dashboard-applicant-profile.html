<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CuroJobs - Applicant Profile</title>
    <link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/style.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/responsive.css" media="all">
</head>

<body>
    <div class="main-page-wrapper">
        <aside class="dash-aside-navbar">
            <div class="position-relative">
                <div class="logo text-md-center d-flex align-items-center justify-content-center">
                    <a href="../../index.html"><img src="../../images/logo/logo_02.png" alt="" class="curo"></a>
                </div>
                <div class="user-data">
                    <div class="user-avatar online position-relative rounded-circle"><img src="../../images/avatar_01.jpg" alt="" class="lazy-img"></div>
                    <div class="user-name-data">
                        <button class="user-name dropdown-toggle" id="profile-dropdown" data-bs-toggle="dropdown" aria-expanded="false">Loading...</button>
                        <ul class="dropdown-menu" aria-labelledby="profile-dropdown">
                            <li><a class="dropdown-item d-flex align-items-center" href="employer-dashboard-profile.html"><img src="../../images/icon/icon_23.svg" alt="" class="lazy-img me-2"><span>Profile</span></a></li>
                        </ul>
                    </div>
                </div>
                <nav class="dasboard-main-nav">
                    <ul class="style-none">
                        <li><a href="employer-dashboard-index.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_1.svg" alt=""><span>Dashboard</span></a></li>
                        <li><a href="employer-dashboard-profile.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_2.svg" alt=""><span>My Profile</span></a></li>
                        <li><a href="employer-dashboard-jobs.html" class="d-flex w-100 align-items-center active"><img src="../../images/icon/icon_3_active.svg" alt=""><span>My Jobs</span></a></li>
                        <li><a href="employer-dashboard-submit-job.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_39.svg" alt=""><span>Submit Job</span></a></li>
						<li><a href="employer-dashboard-message.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_4.svg" alt=""><span>Messages</span></a></li>
                        <li><a href="employer-dashboard-message-setting.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_7.svg" alt=""><span>Msg Settings</span></a></li>
                        <li class="border-top pt-10 mt-10"><a href="../../index.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_8.svg" alt=""><span>Back to Home</span></a></li>
                        <li><a href="#" id="logout-btn" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_9.svg" alt=""><span>Logout</span></a></li>
                    </ul>
                </nav>
            </div>
        </aside>

        <div class="dashboard-body">
            <div class="position-relative">
                <header class="dashboard-header"></header>
                <h2 class="main-title">Applicant Profile</h2>
                
                <div class="bg-white card-box border-20">
                    <div id="profile-container" class="row">
                        <div class="col-12"><div class="text-center p-5"><h4>Loading applicant profile...</h4></div></div>
                    </div>
                </div>
            </div>
        </div>
        
        <script src="../../vendor/jquery.min.js"></script>
        <script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="../../vendor/jwt-decode.js"></script>
        <script src="../../js/theme.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) { window.location.href = '/curojobs-main/login.html'; return; }
                try {
                    const decodedToken = jwt_decode(accessToken);
                    if (decodedToken.user_type !== 'company') { window.location.href = '/curojobs-main/index.html'; return; }
                } catch (e) {
                    localStorage.clear();
                    window.location.href = '/curojobs-main/login.html';
                    return;
                }

                const params = new URLSearchParams(window.location.search);
                const applicantId = params.get('applicantId');
                const profileContainer = document.getElementById('profile-container');
                const profileNameEl = document.getElementById('profile-dropdown');
                const logoutBtn = document.getElementById('logout-btn');
                const baseApiURL = 'http://127.0.0.1:8000/api/v1/accounts/applicants/';

                if (!applicantId) {
                    profileContainer.innerHTML = '<div class="p-5 text-center text-danger"><h3>Error: Applicant ID is missing.</h3></div>';
                    return;
                }

                const apiFetch = async (endpoint, options = {}) => {
                    const headers = { 'Authorization': `Bearer ${accessToken}` };
                    const response = await fetch(endpoint, { ...options, headers });
                     if(response.status === 401) { 
                        localStorage.clear();
                        window.location.href = '/curojobs-main/login.html';
                    }
                    return response;
                };

                const fetchEmployerProfile = async () => {
                     try {
                        const response = await apiFetch('http://127.0.0.1:8000/api/v1/accounts/profile/company/');
                        if (!response.ok) return;
                        const profile = await response.json();
                        profileNameEl.textContent = profile.name || 'Employer';
                    } catch (error) { console.error('Error fetching employer profile:', error); }
                };

                const fetchApplicantProfile = async () => {
                    try {
                        const response = await apiFetch(`${baseApiURL}${applicantId}/`);
                        if (!response.ok) throw new Error('Applicant profile not found or you do not have permission to view it.');
                        
                        const applicant = await response.json();
                        
                        let skillsHtml = applicant.skills ? applicant.skills.split(',').map(skill => `<li>${skill.trim()}</li>`).join('') : '<li>No skills listed.</li>';
                        let educationHtml = applicant.education.length > 0 ? applicant.education.map(edu => `
                            <div class="time-line-data position-relative">
                                <div class="info">
                                    <h6 class="mb-0">${edu.title}</h6>
                                    <span>${edu.academy}</span>
                                    <p>${edu.start_year} - ${edu.end_year}</p>
                                </div>
                            </div>`).join('') : '<p>No education history provided.</p>';
                        
                        let experienceHtml = applicant.experience.length > 0 ? applicant.experience.map(exp => `
                             <div class="time-line-data position-relative">
                                <div class="info">
                                    <h6 class="mb-0">${exp.title}</h6>
                                    <span>${exp.company}</span>
                                    <p>${exp.start_year} - ${exp.end_year || 'Present'}</p>
                                </div>
                            </div>`).join('') : '<p>No work experience provided.</p>';
                        
                        const applicantInitial = applicant.full_name ? applicant.full_name.charAt(0).toUpperCase() : '?';

                        profileContainer.innerHTML = `
                            <div class="col-lg-8">
                                <div class="dash-input-wrapper">
                                    <h6 class="dash-title-three">About Me</h6>
                                    <p>${applicant.bio || 'No bio provided.'}</p>
                                </div>
                                <div class="border-top mt-40 pt-40">
                                    <h4 class="dash-title-three">Education</h4>
                                    ${educationHtml}
                                </div>
                                <div class="border-top mt-40 pt-40">
                                    <h4 class="dash-title-three">Work Experience</h4>
                                    ${experienceHtml}
                                </div>
                                <div class="border-top mt-40 pt-40">
                                    <h4 class="dash-title-three">Skills</h4>
                                    <ul class="style-none skill-tags d-flex flex-wrap">${skillsHtml}</ul>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="candidate-profile-card ms-lg-5">
                                    <div class="cadidate-avatar online position-relative d-flex align-items-center justify-content-center m-auto" 
                                        style="background-color: #f0f5ff; width: 80px; height: 80px; border-radius: 50%; font-size: 40px; font-weight: 500; color: #4866a6;">
                                        ${applicantInitial}
                                    </div>
                                    <h4 class="name text-center mt-20">${applicant.full_name}</h4>
                                    <div class="candidate-post text-center">${applicant.job_title || 'Not specified'}</div>
                                    <ul class="style-none candidate-info mt-25">
                                        <li><span>Location:</span> ${applicant.city || 'Not specified'}</li>
                                        <li><span>Email:</span> <a href="mailto:${applicant.email}">${applicant.email}</a></li>
                                    </ul>
                                    <a href="${applicant.cv}" target="_blank" class="btn-one w-100 mt-20">Download CV</a>
                                </div>
                            </div>
                        `;

                    } catch (error) {
                        profileContainer.innerHTML = `<div class="p-5 text-center text-danger"><h3>Error</h3><p>${error.message}</p></div>`;
                    }
                };
                
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.clear();
                    window.location.href = '../../index.html';
                });

                fetchEmployerProfile();
                fetchApplicantProfile();
            });
        </script>
    </div>
</body>
</html>