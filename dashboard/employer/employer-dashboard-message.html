<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CuroJobs - Messages</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="56x56" href="../../images/fav-icon/icon.png">
    <link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/style.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/responsive.css" media="all">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Chat Bubble Styles */
        .email-body { display: flex; flex-direction: column; padding: 20px; gap: 15px; }
        .message-bubble { max-width: 75%; width: fit-content; padding: 10px 15px; border-radius: 18px; }
        .message-author { font-size: 13px; font-weight: 500; margin-bottom: 5px; }
        .message-text { white-space: pre-wrap; word-wrap: break-word; font-size: 15px; margin: 0; }
        .message-time { font-size: 11px; opacity: 0.7; margin-top: 5px; text-align: right; }
        .message-bubble.sent { background-color: #244034; color: white; border-bottom-right-radius: 4px; align-self: flex-end; }
        .message-bubble.sent .message-author { color: #bde0cf; }
        .message-bubble.received { background-color: #f1f0f0; color: #333; border-bottom-left-radius: 4px; align-self: flex-start; }
        .message-bubble.received .message-author { color: #555; }
        /* Reply Form Styles */
        .reply-form-container { border-top: 1px solid #dee2e6; background-color: #f8f9fa; }
        #reply-form textarea { border-radius: 20px; resize: none; overflow-y: hidden; max-height: 120px; }
        #reply-form button { background-color: #244034; color: white; border-radius: 50%; width: 40px; height: 40px; border: none; flex-shrink: 0; }
        /* Context Menu Styles */
        .context-menu { position: absolute; display: none; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 6px 0; z-index: 1000; min-width: 160px; }
        .context-menu-item { display: flex; align-items: center; padding: 8px 15px; cursor: pointer; font-size: 14px; }
        .context-menu-item:hover { background-color: #f5f5f5; }
        .context-menu-item.delete { color: #dc3545; }
        .context-menu-item i { margin-right: 10px; }
        /* Other Styles */
        .date-separator { text-align: center; color: #999; font-size: 12px; padding: 15px 0; }
        .email-list-item.selected { background-color: #f0f5f3; border-left: 3px solid #244034; }
        .notification-badge { position: absolute; top: 15px; right: 25px; height: 10px; width: 10px; background-color: #dc3545; border-radius: 50%; border: 2px solid white; display: none; }
        /* Ensure select dropdowns in modal are styled */
        .modal .form-select {
            display: block; /* Override potential display issues */
            width: 100%;
            padding: .375rem 2.25rem .375rem .75rem;
             -moz-padding-start: calc(0.75rem - 3px);
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #212529;
            background-color: #fff;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right .75rem center;
            background-size: 16px 12px;
            border: 1px solid #ced4da;
            border-radius: .375rem;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
            appearance: none;
        }

    </style>
</head>

<body>
    <div class="main-page-wrapper">
         <div id="preloader">
            <div id="ctn-preloader" class="ctn-preloader">
                <div class="icon"><img src="../../images/loader.svg" alt="" class="m-auto d-block" width="60"></div>
                 <div class="txt-loading">
                     <span data-text-preloader="C" class="letters-loading">C</span>
                     <span data-text-preloader="U" class="letters-loading">U</span>
                     <span data-text-preloader="R" class="letters-loading">R</span>
                     <span data-text-preloader="O" class="letters-loading">O</span>
                     <span data-text-preloader="J" class="letters-loading">J</span>
                     <span data-text-preloader="O" class="letters-loading">O</span>
                     <span data-text-preloader="B" class="letters-loading">B</span>
                     <span data-text-preloader="S" class="letters-loading">S</span>
                 </div>
            </div>
       </div>

        <aside class="dash-aside-navbar">
            <div class="position-relative">
                <div class="logo text-md-center d-flex align-items-center justify-content-between">
                    <a href="../../index.html"><img src="../../images/logo/logo_02.png" alt="" class="curo"></a>
                    <button class="close-btn d-block d-md-none"><i class="bi bi-x-lg"></i></button>
                </div>
                <div class="user-data">
                    <div class="user-avatar online position-relative rounded-circle">
                         <img id="company-logo-preview" src="../../images/placeholder.jpeg" alt="" class="lazy-img">
                    </div>
                    <div class="user-name-data">
                        <div class="user-name" id="profile-dropdown">Loading...</div>
                    </div>
                </div>
                <nav class="dasboard-main-nav">
                    <ul class="style-none">
                        <li><a href="employer-dashboard-index.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_1.svg" alt=""><span>Dashboard</span></a></li>
                        <li><a href="employer-dashboard-profile.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_2.svg" alt=""><span>My Profile</span></a></li>
                        <li><a href="employer-dashboard-jobs.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_3.svg" alt=""><span>My Jobs</span></a></li>
                        <li><a href="employer-dashboard-submit-job.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_39.svg" alt=""><span>Submit Job</span></a></li>
                        <li id="messages-nav-item" style="position: relative;">
                            <a href="employer-dashboard-message.html" class="d-flex w-100 align-items-center active">
                                <img src="../../images/icon/icon_4_active.svg" alt=""><span>Messages</span>
                            </a>
                            <span class="notification-badge"></span>
                        </li>
                         <li><a href="employer-dashboard-message-settings.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_7.svg" alt=""><span>Msg Settings</span></a></li>
                        <li class="border-top pt-10 mt-10"><a href="../../index.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_8.svg" alt=""><span>Back to Home</span></a></li>
                        <li><a href="#" id="logout-btn" class="d-flex w-100 align-items-center "><img src="../../images/icon/icon_9.svg" alt=""><span>Logout</span></a></li>
                    </ul>
                </nav>
            </div>
        </aside>

        <div class="dashboard-body">
            <div class="position-relative">
                <header class="dashboard-header"><h2 class="main-title m0">Messages</h2></header>
                <div id="message-container-main" class="alert mt-3" style="display: none;"></div>
                <div class="bg-white card-box border-20 p0 mt-30">
                    <div class="message-wrapper">
                        <div class="row gx-0">
                            <div class="col-lg-4">
                                <div class="message-sidebar pt-20">
                                    <div class="ps-3 pe-3 ps-xxl-4 pe-xxl-4">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="page-title fw-500">Inbox</div>
                                            <button class="btn btn-sm btn-outline-primary rounded-circle" id="compose-btn" data-bs-toggle="modal" data-bs-target="#composeModal" title="Compose New Message">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                            </div>
                                    </div>
                                    <div id="conversation-list-container" class="email-read-panel">
                                         </div>
                                </div>
                            </div>
                            <div class="col-lg-8">
                                <div id="conversation-display-container" class="open-email-container d-flex flex-column" style="height: 75vh;">
                                    <div class="text-center p-5 m-auto">Select a conversation to view.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="context-menu" class="context-menu">
            <div id="context-menu-delete" class="context-menu-item delete">
                <i class="bi bi-trash3"></i>
                <span>Delete Conversation</span>
            </div>
        </div>

        <div class="modal fade" id="composeModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Compose New Message</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="compose-message-container" class="alert" style="display: none;"></div>
                        <form id="compose-form">
                            <div class="row">
                                <div class="col-md-6">
                                     <div class="dash-input-wrapper mb-25">
                                        <label for="compose-recipient">To (Applicant)*</label>
                                        <select id="compose-recipient" name="recipient" class="form-select" required>
                                            <option value="">Loading applicants...</option>
                                            </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                     <div class="dash-input-wrapper mb-25">
                                        <label for="compose-template">Use Template (Optional)</label>
                                        <select id="compose-template" class="form-select">
                                            <option value="">Select a template...</option>
                                            </select>
                                    </div>
                                </div>
                                <div class="col-12">
                                     <div class="dash-input-wrapper mb-25">
                                        <label for="compose-subject">Subject*</label>
                                        <input type="text" id="compose-subject" name="subject" class="form-control" required>
                                    </div>
                                </div>
                                <div class="col-12">
                                     <div class="dash-input-wrapper mb-25">
                                        <label for="compose-body">Body*</label>
                                        <textarea id="compose-body" name="body" class="form-control" rows="8" required></textarea>
                                        <div class="form-text small">Placeholders {applicant_name} and {company_name} will be replaced if found.</div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="dash-cancel-btn tran3s" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="dash-btn-two tran3s" id="send-compose-btn">Send Message</button>
                    </div>
                </div>
            </div>
        </div>
        </div> <button class="scroll-top">
        <i class="bi bi-arrow-up-short"></i>
    </button>

        <script src="../../vendor/jquery.min.js"></script>
        <script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

        <script src="../../vendor/jquery.lazy.min.js"></script>

        <script src="../../vendor/jwt-decode.js"></script>

        <script src="../../js/theme.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) { window.location.href = '../../login.html'; return; }
            
            let currentUser;
            try {
                currentUser = jwt_decode(accessToken);
                if (currentUser.user_type !== 'company') { window.location.href = '../../index.html'; return; }
            } catch (e) {
                localStorage.clear();
                window.location.href = '../../login.html';
                return;
            }

            // --- Elements ---
            const conversationListContainer = document.getElementById('conversation-list-container');
            const conversationDisplayContainer = document.getElementById('conversation-display-container');
            const profileNameEl = document.getElementById('profile-dropdown');
            const logoPreview = document.getElementById('company-logo-preview'); // For sidebar logo
            const logoutBtn = document.getElementById('logout-btn');
            const mainMessageContainer = document.getElementById('message-container-main');
            const contextMenu = document.getElementById('context-menu');
            const contextMenuDeleteBtn = document.getElementById('context-menu-delete');
            const composeModalEl = document.getElementById('composeModal');
            const composeModal = new bootstrap.Modal(composeModalEl);
            const composeForm = document.getElementById('compose-form');
            const composeRecipientSelect = document.getElementById('compose-recipient');
            const composeTemplateSelect = document.getElementById('compose-template');
            const composeSubjectInput = document.getElementById('compose-subject');
            const composeBodyTextarea = document.getElementById('compose-body');
            const sendComposeBtn = document.getElementById('send-compose-btn');
            const composeMessageContainer = document.getElementById('compose-message-container');

            // --- API Endpoints ---
            const BASE_API_URL = 'http://127.0.0.1:8000/api/v1/accounts/';
            // const JOBS_API_URL = 'http://127.0.0.1:8000/api/v1/jobs/'; // If needed later

            // --- State ---
            let conversations = {};
            let companyTemplates = [];
            let companyApplicants = [];
            let companyProfileData = {};

            // --- API Fetch Utility ---
            const apiFetch = async (endpoint, options = {}) => {
                const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` };
                try {
                    const response = await fetch(`${BASE_API_URL}${endpoint}`, { ...options, headers });
                    if (response.status === 401) { localStorage.clear(); window.location.href = '../../login.html'; throw new Error('Unauthorized');}
                    return response;
                } catch(error) { /* ... error handling ... */ throw error; }
            };

            // --- Show Message Utility ---
            const showMessage = (message, isError = false, container = mainMessageContainer) => {
                 container.textContent = message;
                 container.className = `alert ${isError ? 'alert-danger' : 'alert-success'} ${container === modalMessageContainer ? 'mb-3' : 'mt-3'}`; // Adjust margin based on container
                 container.style.display = 'block';
                 setTimeout(() => { container.style.display = 'none'; }, 4000);
            };

            // --- Conversation Logic ---
            const getConversationId = (msg) => {
                const participantIds = [msg.sender, msg.recipient].sort();
                const baseSubject = msg.subject.replace(/^(Re: )+/i, '').trim();
                return `${participantIds[0]}-${participantIds[1]}-${baseSubject}`;
            };

            const checkUnreadMessages = async () => { /* ... Keep existing logic ... */ };

            const displayConversation = async (conversationId) => { /* ... Keep existing logic ... */ };
            const renderConversationList = (activeConversationId) => { /* ... Keep existing logic ... */ };
            const deleteConversation = (conversationId) => { /* ... Keep existing logic ... */ };
            const fetchMessages = async (conversationToDisplay) => { /* ... Keep existing logic ... */ };


            // --- NEW: Fetch Company Profile ---
             const fetchCompanyProfile = async () => {
                 try {
                     const response = await apiFetch('profile/company/');
                     if (!response.ok) throw new Error('Failed fetch');
                     companyProfileData = await response.json();
                     // Update sidebar
                     profileNameEl.textContent = companyProfileData.name || 'Employer';
                     const logoUrl = companyProfileData.logo || '../../images/placeholder.jpeg';
                     if(logoPreview) logoPreview.src = logoUrl;
                     localStorage.setItem('companyLogo', logoUrl);
                 } catch (error) {
                      console.error('Error fetching company profile:', error);
                      profileNameEl.textContent = 'Employer'; // Fallback
                 }
             };
             // Use saved logo immediately
             const savedLogo = localStorage.getItem('companyLogo');
             if (savedLogo && logoPreview) logoPreview.src = savedLogo;

            // --- NEW: Fetch Applicants ---
            const fetchApplicantsForCompose = async () => {
                composeRecipientSelect.innerHTML = '<option value="">Loading applicants...</option>';
                try {
                    const response = await apiFetch('company-applicants/'); // Use new endpoint
                    if (!response.ok) throw new Error('Failed to fetch applicants');
                    companyApplicants = await response.json();

                    composeRecipientSelect.innerHTML = '<option value="">Select Applicant...</option>';
                    companyApplicants.forEach(app => {
                         // API returns Applicant objects, need user ID from nested user object
                        const userId = app.user.id;
                        const name = app.full_name || app.username || `User ${userId}`;
                        composeRecipientSelect.innerHTML += `<option value="${userId}">${name}</option>`;
                    });
                } catch (error) {
                    console.error("Error fetching applicants:", error);
                    composeRecipientSelect.innerHTML = '<option value="">Error loading applicants</option>';
                }
            };

            // --- NEW: Fetch Templates ---
            const fetchTemplatesForCompose = async () => {
                composeTemplateSelect.innerHTML = '<option value="">Loading templates...</option>';
                try {
                    const response = await apiFetch('company-message-templates/'); // Use new endpoint
                    if (!response.ok) throw new Error('Failed fetch');
                    companyTemplates = await response.json();

                    composeTemplateSelect.innerHTML = '<option value="">Select a template...</option>';
                    companyTemplates.forEach(tmpl => {
                        composeTemplateSelect.innerHTML += `<option value="${tmpl.id}">${tmpl.name} (${tmpl.template_type})</option>`;
                    });
                } catch (error) {
                    console.error("Error fetching templates:", error);
                    composeTemplateSelect.innerHTML = '<option value="">Error loading templates</option>';
                }
            };

            // --- NEW: Handle Template Selection ---
            composeTemplateSelect.addEventListener('change', (e) => {
                const templateId = e.target.value;
                if (!templateId) {
                    composeSubjectInput.value = '';
                    composeBodyTextarea.value = '';
                    return;
                }
                const selectedTemplate = companyTemplates.find(t => t.id == templateId);
                if (selectedTemplate) {
                    composeSubjectInput.value = selectedTemplate.subject;
                    composeBodyTextarea.value = selectedTemplate.body;
                }
            });

            // --- NEW: Handle Compose Modal Opening ---
             composeModalEl.addEventListener('show.bs.modal', () => {
                composeForm.reset();
                composeMessageContainer.style.display = 'none';
                // Fetch fresh lists when modal opens
                fetchApplicantsForCompose();
                fetchTemplatesForCompose();
             });

             // --- NEW: Handle Sending Composed Message ---
             sendComposeBtn.addEventListener('click', async () => {
                 if (!composeForm.checkValidity()) {
                     composeForm.reportValidity();
                     showMessage('Please select an applicant and fill in subject/body.', true, composeMessageContainer);
                     return;
                 }

                 sendComposeBtn.disabled = true;
                 sendComposeBtn.textContent = 'Sending...';

                 const recipientId = composeRecipientSelect.value;
                 let subject = composeSubjectInput.value;
                 let body = composeBodyTextarea.value;

                 // Attempt placeholder replacement
                 const selectedApplicant = companyApplicants.find(a => a.user.id == recipientId);
                 // Fallback name if applicant somehow not found (shouldn't happen if selected)
                 const applicantName = selectedApplicant ? (selectedApplicant.full_name || selectedApplicant.username) : 'Applicant';
                 const companyName = companyProfileData.name || 'Our Company';

                 subject = subject.replace(/{applicant_name}/g, applicantName)
                                  .replace(/{company_name}/g, companyName);
                                  // Add {job_title} replacement if relevant context available
                 body = body.replace(/{applicant_name}/g, applicantName)
                            .replace(/{company_name}/g, companyName);

                 const data = {
                     recipient: recipientId,
                     subject: subject,
                     body: body
                 };

                 try {
                     const response = await apiFetch('messages/send/', { // Use the company's send endpoint
                         method: 'POST',
                         body: JSON.stringify(data)
                     });
                     if (!response.ok) {
                         const errorData = await response.json();
                         throw new Error(errorData.detail || `Failed to send (${response.status})`);
                     }
                     showMessage('Message sent successfully!', false); // Show on main page
                     composeModal.hide();
                     fetchMessages(); // Refresh conversation list

                 } catch (error) {
                     showMessage(error.message, true, composeMessageContainer); // Show error in modal
                 } finally {
                     sendComposeBtn.disabled = false;
                     sendComposeBtn.textContent = 'Send Message';
                 }
             });


            // --- Existing Event Listeners ---
            window.addEventListener('click', () => { contextMenu.style.display = 'none'; });
            contextMenuDeleteBtn.addEventListener('click', () => { /* ... existing ... */ });
            logoutBtn.addEventListener('click', (e) => { /* ... existing ... */ });

            // --- Initial Load ---
            // Fetch company profile first for placeholders, then messages
            fetchCompanyProfile().then(() => {
                fetchMessages();
                checkUnreadMessages();
            });

        });
        </script>
    </div>
</body>
</html>