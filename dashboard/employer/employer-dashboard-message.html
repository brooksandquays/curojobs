<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CuroJobs - Messages</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="56x56" href="../../images/fav-icon/icon.png">
    <link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/style.css" media="all">
    <link rel="stylesheet" type="text/css" href="../../css/responsive.css" media="all">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Chat Bubble Styles */
        .email-body { display: flex; flex-direction: column; padding: 20px; gap: 15px; }
        .message-bubble { max-width: 75%; width: fit-content; padding: 10px 15px; border-radius: 18px; }
        .message-author { font-size: 13px; font-weight: 500; margin-bottom: 5px; }
        .message-text { white-space: pre-wrap; word-wrap: break-word; font-size: 15px; margin: 0; }
        .message-time { font-size: 11px; opacity: 0.7; margin-top: 5px; text-align: right; }
        .message-bubble.sent { background-color: #244034; color: white; border-bottom-right-radius: 4px; align-self: flex-end; }
        .message-bubble.sent .message-author { color: #bde0cf; }
        .message-bubble.received { background-color: #f1f0f0; color: #333; border-bottom-left-radius: 4px; align-self: flex-start; }
        .message-bubble.received .message-author { color: #555; }
        /* Reply Form Styles */
        .reply-form-container { border-top: 1px solid #dee2e6; background-color: #f8f9fa; }
        #reply-form textarea { border-radius: 20px; resize: none; overflow-y: hidden; max-height: 120px; }
        #reply-form button { background-color: #244034; color: white; border-radius: 50%; width: 40px; height: 40px; border: none; flex-shrink: 0; }
        /* Context Menu Styles */
        .context-menu { position: absolute; display: none; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 6px 0; z-index: 1000; min-width: 160px; }
        .context-menu-item { display: flex; align-items: center; padding: 8px 15px; cursor: pointer; font-size: 14px; }
        .context-menu-item:hover { background-color: #f5f5f5; }
        .context-menu-item.delete { color: #dc3545; }
        .context-menu-item i { margin-right: 10px; }
        /* Other Styles */
        .date-separator { text-align: center; color: #999; font-size: 12px; padding: 15px 0; }
        .email-list-item.selected { background-color: #f0f5f3; border-left: 3px solid #244034; }
        .notification-badge { position: absolute; top: 15px; right: 25px; height: 10px; width: 10px; background-color: #dc3545; border-radius: 50%; border: 2px solid white; display: none; }
        /* Ensure select dropdowns in modal are styled */
        .modal .form-select {
            display: block; /* Override potential display issues */
            width: 100%;
            padding: .375rem 2.25rem .375rem .75rem;
             -moz-padding-start: calc(0.75rem - 3px);
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #212529;
            background-color: #fff;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right .75rem center;
            background-size: 16px 12px;
            border: 1px solid #ced4da;
            border-radius: .375rem;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
            appearance: none;
        }

    </style>
        <style>
        /* --- Sidebar User Data Alignment --- */
        .dash-aside-navbar .user-data {
            display: flex;         /* Use flexbox for alignment */
            flex-direction: column; /* Stack items vertically */
            align-items: center;   /* Center items horizontally */
            text-align: center;    /* Center the text within the name container */
            margin-bottom: 20px;   /* Add some space below the name */
            padding-top: 15px;      /* Add some top padding */
        }

        .dash-aside-navbar .user-avatar {
            width: 60px;          /* Set a specific size for the logo container */
            height: 60px;
            margin-bottom: 10px;   /* Add space between logo and name */
        }
        
        /* Ensure image fills the circle */
        .dash-aside-navbar .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .dash-aside-navbar .user-name-data {
            margin-top: 0;         /* Remove default top margin if any */
        }

        .dash-aside-navbar .user-name {
            font-size: 16px;       /* Adjust font size as needed */
            font-weight: 500;
            color: #333;          /* Adjust text color if needed */
        }
        
        /* Ensure placeholder fits */
         #company-logo-preview {
             width: 100%; 
             height: 100%; 
             object-fit: cover;
         }
    </style>
</head>

<body>
    <div class="main-page-wrapper">
         <div id="preloader">
            <div id="ctn-preloader" class="ctn-preloader">
                <div class="icon"><img src="../../images/loader.svg" alt="" class="m-auto d-block" width="60"></div>
                 <div class="txt-loading">
                     <span data-text-preloader="C" class="letters-loading">C</span>
                     <span data-text-preloader="U" class="letters-loading">U</span>
                     <span data-text-preloader="R" class="letters-loading">R</span>
                     <span data-text-preloader="O" class="letters-loading">O</span>
                     <span data-text-preloader="J" class="letters-loading">J</span>
                     <span data-text-preloader="O" class="letters-loading">O</span>
                     <span data-text-preloader="B" class="letters-loading">B</span>
                     <span data-text-preloader="S" class="letters-loading">S</span>
                 </div>
            </div>
       </div>

        <aside class="dash-aside-navbar">
            <div class="position-relative">
                <div class="logo text-md-center d-flex align-items-center justify-content-between">
                    <a href="../../index.html"><img src="../../images/logo/logo_02.png" alt="" class="curo"></a>
                    <button class="close-btn d-block d-md-none"><i class="bi bi-x-lg"></i></button>
                </div>
                <div class="user-data">
                    <div class="user-avatar online position-relative rounded-circle">
                         <img id="company-logo-preview" src="../../images/placeholder.jpeg" alt="" class="lazy-img">
                    </div>
                    <div class="user-name-data">
                        <div class="user-name" id="profile-dropdown">Loading...</div>
                    </div>
                </div>
                <nav class="dasboard-main-nav">
                    <ul class="style-none">
                        <li><a href="employer-dashboard-index.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_1.svg" alt=""><span>Dashboard</span></a></li>
                        <li><a href="employer-dashboard-profile.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_2.svg" alt=""><span>My Profile</span></a></li>
                        <li><a href="employer-dashboard-jobs.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_3.svg" alt=""><span>My Jobs</span></a></li>
                        <li><a href="employer-dashboard-submit-job.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_39 copy.svg" alt=""><span>Submit Job</span></a></li>
                        <li id="messages-nav-item" style="position: relative;">
                            <a href="employer-dashboard-message.html" class="d-flex w-100 align-items-center active">
                                <img src="../../images/icon/icon_4_active.svg" alt=""><span>Messages</span>
                            </a>
                            <span class="notification-badge"></span>
                        </li>
                         <li><a href="employer-dashboard-message-setting.html" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_7.svg" alt=""><span>Msg Settings</span></a></li>
                        <li><a href="../../index.html" class="d-flex w-100 align-items-center mt-10 pt-10"><img src="../../images/icon/icon_30 copy.svg" alt=""><span>Back to Home</span></a></li>
                        <li><a href="#" id="logout-btn" class="d-flex w-100 align-items-center"><img src="../../images/icon/icon_9.svg" alt=""><span>Logout</span></a></li>
                    </ul>
                </nav>
            </div>
        </aside>

        <div class="dashboard-body">
            <div class="position-relative">
                <header class="dashboard-header"><h2 class="main-title m0">Messages</h2></header>
                <div id="message-container-main" class="alert mt-3" style="display: none;"></div>
                <div class="bg-white card-box border-20 p0 mt-30">
                    <div class="message-wrapper">
                        <div class="row gx-0">
                            <div class="col-lg-4">
                                <div class="message-sidebar pt-20">
                                    <div class="ps-3 pe-3 ps-xxl-4 pe-xxl-4">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="page-title fw-500">Inbox</div>
                                            <button class="btn btn-sm btn-outline-primary rounded-circle" id="compose-btn" data-bs-toggle="modal" data-bs-target="#composeModal" title="Compose New Message">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                            </div>
                                    </div>
                                    <div id="conversation-list-container" class="email-read-panel">
                                         </div>
                                </div>
                            </div>
                            <div class="col-lg-8">
                                <div id="conversation-display-container" class="open-email-container d-flex flex-column" style="height: 75vh;">
                                    <div class="text-center p-5 m-auto">Select a conversation to view.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="context-menu" class="context-menu">
            <div id="context-menu-delete" class="context-menu-item delete">
                <i class="bi bi-trash3"></i>
                <span>Delete Conversation</span>
            </div>
        </div>

        <div class="modal fade" id="composeModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Compose New Message</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="compose-message-container" class="alert" style="display: none;"></div>
                        <form id="compose-form">
                            <div class="row">
                                <div class="col-md-6">
                                     <div class="dash-input-wrapper mb-25">
                                        <label for="compose-recipient">To (Applicant)*</label>
                                        <select id="compose-recipient" name="recipient" class="form-select" required>
                                            <option value="">Loading applicants...</option>
                                            </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                     <div class="dash-input-wrapper mb-25">
                                        <label for="compose-template">Use Template (Optional)</label>
                                        <select id="compose-template" class="form-select">
                                            <option value="">Select a template...</option>
                                            </select>
                                    </div>
                                </div>
                                <div class="col-12">
                                     <div class="dash-input-wrapper mb-25">
                                        <label for="compose-subject">Subject*</label>
                                        <input type="text" id="compose-subject" name="subject" class="form-control" required>
                                    </div>
                                </div>
                                <div class="col-12">
                                     <div class="dash-input-wrapper mb-25">
                                        <label for="compose-body">Body*</label>
                                        <textarea id="compose-body" name="body" class="form-control" rows="8" required></textarea>
                                        <div class="form-text small">Placeholders {applicant_name} and {company_name} will be replaced if found.</div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="dash-cancel-btn tran3s" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="dash-btn-two tran3s" id="send-compose-btn">Send Message</button>
                    </div>
                </div>
            </div>
        </div>
        </div> <button class="scroll-top">
        <i class="bi bi-arrow-up-short"></i>
    </button>

        <script src="../../vendor/jquery.min.js"></script>
        <script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        
        <script src="../../vendor/wow/wow.min.js"></script> 
        
        <script src="../../vendor/jquery.lazy.min.js"></script>
        <script src="../../vendor/jwt-decode.js"></script>
        <script src="../../js/theme.js"></script>
        
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. AUTH & CONFIG ---
            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) { window.location.href = '../../login.html'; return; }
            
            let currentUser;
            try {
                currentUser = jwt_decode(accessToken);
                if (currentUser.user_type !== 'company') { window.location.href = '../../index.html'; return; }
            } catch (e) {
                localStorage.clear();
                window.location.href = '../../login.html';
                return;
            }

            // --- 2. ELEMENTS ---
            const conversationListContainer = document.getElementById('conversation-list-container');
            const conversationDisplayContainer = document.getElementById('conversation-display-container');
            const profileNameEl = document.getElementById('profile-dropdown');
            const logoPreview = document.getElementById('company-logo-preview');
            const logoutBtn = document.getElementById('logout-btn');
            const mainMessageContainer = document.getElementById('message-container-main');
            const contextMenu = document.getElementById('context-menu');
            const contextMenuDeleteBtn = document.getElementById('context-menu-delete');
            const composeModalEl = document.getElementById('composeModal');
            const composeModal = new bootstrap.Modal(composeModalEl);
            const composeForm = document.getElementById('compose-form');
            const composeRecipientSelect = document.getElementById('compose-recipient');
            const composeTemplateSelect = document.getElementById('compose-template');
            const composeSubjectInput = document.getElementById('compose-subject');
            const composeBodyTextarea = document.getElementById('compose-body');
            const sendComposeBtn = document.getElementById('send-compose-btn');
            const composeMessageContainer = document.getElementById('compose-message-container');

            // --- 3. API ENDPOINTS ---
            const BASE_API_URL = 'http://127.0.0.1:8000/api/v1/accounts/';

            // --- 4. STATE ---
            let conversations = {}; // This object will hold all grouped conversations
            let companyTemplates = [];
            let companyApplicants = [];
            let companyProfileData = {};

            // --- 5. UTILITY FUNCTIONS ---
            const apiFetch = async (endpoint, options = {}) => {
                const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` };
                // try/catch block is removed for brevity, but you have it in your original
                const response = await fetch(`${BASE_API_URL}${endpoint}`, { ...options, headers });
                if (response.status === 401) { localStorage.clear(); window.location.href = '../../login.html'; throw new Error('Unauthorized');}
                return response;
            };

            const showMessage = (message, isError = false, container = mainMessageContainer) => {
                 container.textContent = message;
                 // This fixes your 'modalMessageContainer is not defined' error
                 container.className = `alert ${isError ? 'alert-danger' : 'alert-success'} ${container === composeMessageContainer ? 'mb-3' : 'mt-3'}`;
                 container.style.display = 'block';
                 setTimeout(() => { container.style.display = 'none'; }, 4000);
            };

            // --- 6. CORE MESSAGING LOGIC ---

            /**
             * Creates a unique ID for a conversation based on participants and subject.
             */
            const getConversationId = (msg) => {
                // Ensure sender and recipient are numbers for consistent sorting
                const participantIds = [parseInt(msg.sender), parseInt(msg.recipient)].sort((a, b) => a - b);
                // Normalize subject: remove 'Re: ' prefixes and trim
                const baseSubject = msg.subject.replace(/^(Re: |re: )+/i, '').trim();
                return `${participantIds[0]}-${participantIds[1]}-${baseSubject}`;
            };

            /**
             * Fetches all messages, groups them, and optionally displays one.
             * @param {string|null} conversationToDisplay - The ID of the conversation to open after fetching.
             */
            const fetchMessages = async (conversationToDisplay = null) => {
                try {
                    const response = await apiFetch('messages/'); // Your MessageListAPIView
                    if (!response.ok) throw new Error('Could not load messages.');
                    
                    const messages = await response.json();
                    
                    conversations = {}; // Reset conversations object

                    // Group messages into conversations
                    messages.forEach(msg => {
                        const convId = getConversationId(msg);
                        if (!conversations[convId]) {
                            const otherUser = msg.sender === currentUser.user_id ? msg.recipient_username : msg.sender_username;
                            const otherUserId = msg.sender === currentUser.user_id ? msg.recipient : msg.sender;
                            const baseSubject = msg.subject.replace(/^(Re: |re: )+/i, '').trim();
                            
                            conversations[convId] = {
                                id: convId,
                                otherUser: otherUser,
                                otherUserId: otherUserId,
                                subject: baseSubject,
                                messages: [],
                                lastMessageTime: null,
                                unread: false
                            };
                        }
                        conversations[convId].messages.push(msg);
                    });

                    // Sort messages within each conversation and find last message time/unread
                    Object.values(conversations).forEach(conv => {
                        conv.messages.sort((a, b) => new Date(a.sent_at) - new Date(b.sent_at));
                        const lastMessage = conv.messages[conv.messages.length - 1];
                        conv.lastMessageTime = lastMessage.sent_at;
                        conv.unread = conv.messages.some(m => !m.is_read && m.recipient === currentUser.user_id);
                    });

                    // Render the sidebar
                    renderConversationList(conversationToDisplay); 
                    
                    // If a specific conversation was requested (e.g., after sending a new message), display it.
                    if (conversationToDisplay && conversations[conversationToDisplay]) {
                        await displayConversation(conversationToDisplay);
                    }

                } catch (error) {
                    console.error('Error fetching messages:', error);
                    conversationListContainer.innerHTML = '<div class="p-3 text-danger">Error loading messages.</div>';
                }
            };

            /**
             * Renders the left-hand sidebar with all conversations.
             * @param {string|null} activeConversationId - The ID of the currently selected conversation.
             */
            const renderConversationList = (activeConversationId = null) => {
                conversationListContainer.innerHTML = ''; // Clear list
                
                const sortedConversations = Object.values(conversations).sort((a, b) => {
                    return new Date(b.lastMessageTime) - new Date(a.lastMessageTime);
                });

                if (sortedConversations.length === 0) {
                    conversationListContainer.innerHTML = '<div class="p-3 text-center text-muted">No conversations.</div>';
                    return;
                }

                sortedConversations.forEach(conv => {
                    const lastMessage = conv.messages[conv.messages.length - 1];
                    const isActive = conv.id === activeConversationId;
                    const isUnread = conv.unread;

                    const item = document.createElement('div');
                    item.className = `email-list-item d-flex ${isActive ? 'selected' : ''} ${isUnread ? 'fw-bold' : ''}`;
                    item.dataset.conversationId = conv.id;
                    item.style.cursor = 'pointer';

                    item.innerHTML = `
                        <div class="logo-initial d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; border-radius: 50%; background-color: #f0f5ff; font-weight: 500; color: #4866a6; flex-shrink: 0;">
                            ${conv.otherUser.charAt(0).toUpperCase()}
                        </div>
                        <div class="email-info flex-grow-1" style="min-width: 0;">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="sender-name truncate">${conv.otherUser}</span>
                                <span class="send-time flex-shrink-0" style="font-size: 12px;">${new Date(conv.lastMessageTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</span>
                            </div>
                            <div class="subject-line truncate">${conv.subject}</div>
                            <div class="email-preview truncate" style="font-size: 13px; opacity: 0.8;">
                                ${lastMessage.body}
                            </div>
                        </div>
                        ${isUnread ? '<div class="notification-dot" style="width: 10px; height: 10px; background-color: #dc3545; border-radius: 50%; margin-left: 10px; align-self: center; flex-shrink: 0;"></div>' : ''}
                    `;
                    
                    item.addEventListener('click', () => {
                        displayConversation(conv.id);
                        renderConversationList(conv.id); // Re-render to highlight this item
                    });

                    item.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        contextMenu.style.top = `${e.pageY}px`;
                        contextMenu.style.left = `${e.pageX}px`;
                        contextMenu.style.display = 'block';
                        contextMenu.dataset.conversationId = conv.id;
                    });

                    conversationListContainer.appendChild(item);
                });
            };

            /**
             * Renders the main chat window for a specific conversation.
             * @param {string} conversationId - The ID of the conversation to display.
             */
            const displayConversation = async (conversationId) => {
                const conv = conversations[conversationId];
                if (!conv) {
                    conversationDisplayContainer.innerHTML = '<div class="text-center p-5 m-auto">Could not find conversation.</div>';
                    return;
                }

                const headerHtml = `
                    <div class="email-header-info p-3 border-bottom d-flex justify-content-between align-items-center">
                        <div>
                            <div class="subject-line fw-500">${conv.subject}</div>
                            <div class="address-line" style="font-size: 14px;">To: ${conv.otherUser}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" id="delete-conv-btn-main" data-conversation-id="${conv.id}" title="Delete Conversation">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;

                let bodyHtml = '<div class="email-body flex-grow-1" style="overflow-y: auto;">';
                let lastDate = null;

                conv.messages.forEach(msg => {
                    const msgDate = new Date(msg.sent_at).toDateString();
                    if (msgDate !== lastDate) {
                        bodyHtml += `<div class="date-separator">${msgDate}</div>`;
                        lastDate = msgDate;
                    }
                    const isSent = msg.sender === currentUser.user_id;
                    const authorName = isSent ? "You" : conv.otherUser;
                    const bubbleClass = isSent ? 'sent' : 'received';
                    
                    bodyHtml += `
                        <div class="message-bubble ${bubbleClass}">
                            <div class="message-author">${authorName}</div>
                            <p class="message-text">${msg.body}</p>
                            <div class="message-time">${new Date(msg.sent_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</div>
                        </div>
                    `;
                });
                bodyHtml += '</div>';

                const replyFormHtml = `
                    <div class="reply-form-container p-3">
                        <form id="reply-form" class="d-flex align-items-center">
                            <textarea id="reply-body" class="form-control" rows="1" placeholder="Type your reply..."></textarea>
                            <button type="submit" class="ms-2" title="Send">
                                <i class="bi bi-send-fill"></i>
                            </button>
                        </form>
                    </div>
                `;

                conversationDisplayContainer.innerHTML = headerHtml + bodyHtml + replyFormHtml;

                const emailBody = conversationDisplayContainer.querySelector('.email-body');
                emailBody.scrollTop = emailBody.scrollHeight;

                // Add Listeners for Reply and Delete
                document.getElementById('reply-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const replyBodyEl = document.getElementById('reply-body');
                    const body = replyBodyEl.value;
                    if (!body.trim()) return;

                    const replyData = {
                        recipient: conv.otherUserId,
                        subject: `Re: ${conv.subject}`,
                        body: body
                    };

                    try {
                        const response = await apiFetch('messages/send/', {
                            method: 'POST',
                            body: JSON.stringify(replyData)
                        });
                        if (!response.ok) throw new Error('Failed to send reply.');
                        await fetchMessages(conversationId); // Re-fetch and re-display this convo
                    } catch (error) {
                        replyBodyEl.value = `Error: ${error.message}`;
                        replyBodyEl.classList.add('is-invalid');
                    }
                });

                document.getElementById('delete-conv-btn-main').addEventListener('click', () => {
                    deleteConversation(conversationId);
                });
                
                // Mark messages as read
                if (conv.unread) {
                    try {
                        await apiFetch('messages/mark-as-read/', {
                            method: 'POST',
                            body: JSON.stringify({ sender_id: conv.otherUserId })
                        });
                        conv.unread = false;
                        conv.messages.forEach(m => {
                            if (m.recipient === currentUser.user_id) m.is_read = true;
                        });
                        renderConversationList(conversationId);
                        checkUnreadMessages();
                    } catch (error) {
                        console.error("Failed to mark messages as read:", error);
                    }
                }
            };

            const deleteConversation = async (conversationId) => {
                const conv = conversations[conversationId];
                if (!conv) return;

                const confirmed = await Swal.fire({
                    title: 'Are you sure?',
                    text: `This will delete the conversation about "${conv.subject}" with ${conv.otherUser}. This cannot be undone.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                });

                if (confirmed.isConfirmed) {
                    try {
                        const response = await apiFetch('messages/delete-conversation/', {
                            method: 'DELETE',
                            body: JSON.stringify({
                                other_user_id: conv.otherUserId,
                                subject: conv.subject
                            })
                        });
                        if (!response.ok) throw new Error('Failed to delete.');
                        
                        showMessage('Conversation deleted.');
                        conversationDisplayContainer.innerHTML = '<div class="text-center p-5 m-auto">Conversation deleted.</div>';
                        delete conversations[conversationId];
                        renderConversationList();
                        
                    } catch (error) {
                        showMessage('Error deleting conversation.', true);
                    }
                }
            };

            const checkUnreadMessages = async () => {
                try {
                    const response = await apiFetch('messages/unread-count/');
                    if (!response.ok) return;
                    const data = await response.json();
                    const badge = document.querySelector('#messages-nav-item .notification-badge');
                    if (data.unread_count > 0) {
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                } catch (error) {
                    console.warn("Could not check unread messages:", error);
                }
            };


            // --- 7. PROFILE & TEMPLATE FETCHING ---
            
             const fetchCompanyProfile = async () => {
                 try {
                     const response = await apiFetch('profile/company/');
                     if (!response.ok) throw new Error('Failed fetch');
                     companyProfileData = await response.json();
                     profileNameEl.textContent = companyProfileData.name || 'Employer';
                     const logoUrl = companyProfileData.logo || '../../images/placeholder.jpeg';
                     if(logoPreview) logoPreview.src = logoUrl;
                     localStorage.setItem('companyLogo', logoUrl);
                 } catch (error) {
                      console.error('Error fetching company profile:', error);
                      profileNameEl.textContent = 'Employer';
                 }
             };
             const savedLogo = localStorage.getItem('companyLogo');
             if (savedLogo && logoPreview) logoPreview.src = savedLogo;

            const fetchApplicantsForCompose = async () => {
                composeRecipientSelect.innerHTML = '<option value="">Loading applicants...</option>';
                try {
                    const response = await apiFetch('company-applicants/');
                    if (!response.ok) throw new Error('Failed to fetch applicants');
                    companyApplicants = await response.json();

                    composeRecipientSelect.innerHTML = '<option value="">Select Applicant...</option>';
                    // This uses the logic from our previous fix
                    companyApplicants.forEach(app => {
                        if (!app) return;
                        const userId = app.user_id || (app.user && app.user.id);
                        if (!userId) {
                            console.warn("Skipping applicant with no User ID:", app);
                            return;
                        }
                        const name = app.full_name || (app.user && app.user.full_name) || app.username || (app.user && app.user.username) || `User ${userId}`;
                        composeRecipientSelect.innerHTML += `<option value="${userId}">${name}</option>`;
                    });
                } catch (error) {
                    console.error("Error fetching applicants:", error);
                    composeRecipientSelect.innerHTML = '<option value="">Error loading applicants</option>';
                }
            };

            const fetchTemplatesForCompose = async () => {
                composeTemplateSelect.innerHTML = '<option value="">Loading templates...</option>';
                try {
                    const response = await apiFetch('company-message-templates/');
                    if (!response.ok) throw new Error('Failed fetch');
                    companyTemplates = await response.json();

                    composeTemplateSelect.innerHTML = '<option value="">Select a template...</option>';
                    companyTemplates.forEach(tmpl => {
                        composeTemplateSelect.innerHTML += `<option value="${tmpl.id}">${tmpl.name} (${tmpl.template_type})</option>`;
                    });
                } catch (error) {
                    console.error("Error fetching templates:", error);
                    composeTemplateSelect.innerHTML = '<option value="">Error loading templates</option>';
                }
            };

            // --- 8. EVENT LISTENERS ---
            
            composeTemplateSelect.addEventListener('change', (e) => {
                const templateId = e.target.value;
                if (!templateId) {
                    composeSubjectInput.value = '';
                    composeBodyTextarea.value = '';
                    return;
                }
                const selectedTemplate = companyTemplates.find(t => t.id == templateId);
                if (selectedTemplate) {
                    composeSubjectInput.value = selectedTemplate.subject;
                    composeBodyTextarea.value = selectedTemplate.body;
                }
            });

             composeModalEl.addEventListener('show.bs.modal', () => {
                composeForm.reset();
                composeMessageContainer.style.display = 'none';
                fetchApplicantsForCompose();
                fetchTemplatesForCompose();
             });

             // --- MODIFIED: This now calls fetchMessages with the new ID ---
             sendComposeBtn.addEventListener('click', async () => {
                 if (!composeForm.checkValidity()) {
                     composeForm.reportValidity();
                     showMessage('Please select an applicant and fill in subject/body.', true, composeMessageContainer);
                     return;
                 }

                 sendComposeBtn.disabled = true;
                 sendComposeBtn.textContent = 'Sending...';

                 const recipientId = composeRecipientSelect.value;
                 let subject = composeSubjectInput.value;
                 let body = composeBodyTextarea.value;

                 // Placeholder replacement
                 const selectedApplicant = companyApplicants.find(a => (a.user_id || (a.user && a.user.id)) == recipientId);
                 const applicantName = selectedApplicant ? (selectedApplicant.full_name || (selectedApplicant.user && selectedApplicant.user.username)) : 'Applicant';
                 const companyName = companyProfileData.name || 'Our Company';

                 subject = subject.replace(/{applicant_name}/g, applicantName)
                                  .replace(/{company_name}/g, companyName);
                 body = body.replace(/{applicant_name}/g, applicantName)
                            .replace(/{company_name}/g, companyName);

                 const data = {
                     recipient: recipientId,
                     subject: subject,
                     body: body
                 };

                 try {
                     const response = await apiFetch('messages/send/', {
                         method: 'POST',
                         body: JSON.stringify(data)
                     });
                     if (!response.ok) {
                         const errorData = await response.json();
                         throw new Error(errorData.detail || `Failed to send (${response.status})`);
                     }
                     
                     // --- THIS IS THE FIX ---
                     showMessage('Message sent successfully!', false);
                     composeModal.hide();

                     // 1. Create the conversation ID of the message we just sent
                     const fakeMessage = {
                         sender: currentUser.user_id,
                         recipient: parseInt(recipientId),
                         subject: composeSubjectInput.value // Use the *original* subject
                     };
                     const newConversationId = getConversationId(fakeMessage);

                     // 2. Re-fetch all messages and automatically display the one we just sent to
                     await fetchMessages(newConversationId); 
                     // --- END OF FIX ---

                 } catch (error) {
                     showMessage(error.message, true, composeMessageContainer);
                 } finally {
                     sendComposeBtn.disabled = false;
                     sendComposeBtn.textContent = 'Send Message';
                 }
             });


            // --- Other Event Listeners ---
            window.addEventListener('click', () => { contextMenu.style.display = 'none'; });
            
            contextMenuDeleteBtn.addEventListener('click', () => {
                const conversationId = contextMenu.dataset.conversationId;
                if (conversationId) {
                    deleteConversation(conversationId);
                }
                contextMenu.style.display = 'none';
            });
            
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.clear();
                window.location.href = '../../index.html';
            });

            // --- 9. INITIAL LOAD ---
            fetchCompanyProfile().then(() => {
                fetchMessages(); // Fetch all messages on initial load
                checkUnreadMessages();
            });
        });
        </script>
    </div>
</body>
</html>