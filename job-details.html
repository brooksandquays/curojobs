<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CuroJobs - Job Details</title>
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="/css/style.css" media="all">
    <link rel="stylesheet" type="text/css" href="/css/responsive.css" media="all">
</head>

<body>
    <div class="main-page-wrapper">
        <header class="theme-main-menu menu-style-one sticky-menu" style="background-color: #244034;">
            <div class="inner-content position-relative">
                <div class="top-header">
                    <div class="d-flex align-items-center">
                        <div class="logo order-lg-0"><a href="/index.html" class="d-flex align-items-center"><img src="/images/logo/logo_01.png" alt=""></a></div>
                        <div class="right-widget ms-auto order-lg-3"><ul id="auth-links" class="d-flex align-items-center style-none"></ul></div>
                        <nav class="navbar navbar-expand-lg p0 ms-lg-5 ms-3 order-lg-2">
                            <ul class="navbar-nav align-items-lg-center">
                                <li class="nav-item"><a class="nav-link" href="/index.html">Home</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </header>

        <div style="padding-top: 120px;">
            <div class="job-details-v1 container">
                <div class="main-wrapper bg-white">
                    <div id="job-details-container">
                        <p class="text-center p-5">Loading job details...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer-one">
             <div class="bottom-footer"><div class="container"><p class="text-center mb-15">Copyright @2025 Curo Jobs Inc.</p></div></div>
        </div>
    </div>

    <script src="/vendor/jwt-decode.js"></script>
    <script src="/js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const jobId = params.get('id');
            const jobDetailsContainer = document.getElementById('job-details-container');
            const authLinksContainer = document.getElementById('auth-links');
            const baseApiURL = 'http://127.0.0.1:8000/api/v1/jobs/';

            if (!jobId) { /* Handle no ID */ return; }

            const setupAuthHeader = () => {
                const accessToken = localStorage.getItem('accessToken');
                if (accessToken) {
                    const decodedToken = jwt_decode(accessToken);
                    let dashboardUrl = '/index.html';
                    if (decodedToken.user_type === 'applicant') {
                        dashboardUrl = '/dashboard/applicant/candidate-dashboard-index.html';
                    } else if (decodedToken.user_type === 'company') {
                        dashboardUrl = '/dashboard/employer/employer-dashboard-index.html';
                    }
                    authLinksContainer.innerHTML = `<li><a href="${dashboardUrl}" class="login-btn-one">Dashboard</a></li><li class="d-none d-md-block ms-4"><a href="#" id="logout-btn" class="btn-one">Logout</a></li>`;
                    document.getElementById('logout-btn')?.addEventListener('click', (e) => {
                        e.preventDefault();
                        localStorage.clear();
                        window.location.href = '/index.html';
                    });
                } else {
                    authLinksContainer.innerHTML = `<li><a href="/login.html" class="login-btn-one">Login | SignUp</a></li>`;
                }
            };

            const fetchJobDetails = async () => {
                try {
                    const response = await apiFetch(`${baseApiURL}${jobId}/`);
                    if (!response || !response.ok) throw new Error('Job not found.');
                    const job = await response.json();
                    
                    document.title = `${job.title} | CuroJobs`;
                    jobDetailsContainer.innerHTML = `
                        <div class="job-header p-4">
                            <h2 class="job-title">${job.title}</h2>
                            <ul class="meta-info d-flex flex-wrap align-items-center">
                                <li>${job.company_name}</li>
                                <li>${job.location}</li>
                                <li>${job.job_type}</li>
                            </ul>
                        </div>
                        <div class="job-body p-4">
                            <h4>Job Description</h4>
                            <p>${job.description.replace(/\\n/g, '<br>')}</p>
                        </div>
                        <div class="p-4"><button id="apply-button" class="btn-one tran3s w-100 mt-25">Apply Now</button></div>
                    `;

                    document.getElementById('apply-button').addEventListener('click', handleApply);
                } catch (error) {
                    jobDetailsContainer.innerHTML = '<h2 class="text-center p-5">Job Not Found</h2>';
                }
            };
            
            const handleApply = async () => {
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken || jwt_decode(accessToken).user_type !== 'applicant') {
                    alert('You must be logged in as an applicant to apply.');
                    return;
                }

                const applyButton = document.getElementById('apply-button');
                applyButton.textContent = 'Applying...';
                applyButton.disabled = true;

                try {
                    const response = await apiFetch(`${baseApiURL}${jobId}/apply/`, { method: 'POST' });
                    
                    if (!response.ok) {
                        const errorResult = await response.json();
                        const errorMessage = errorResult.detail || (Array.isArray(errorResult) ? errorResult[0] : 'Application failed.');
                        throw new Error(errorMessage);
                    }
                    
                    alert('Application successful!');
                    applyButton.textContent = 'Applied Successfully';

                } catch (error) {
                    // CORRECTED ALERT: Shows only the specific message from the backend
                    alert(error.message); 
                    applyButton.textContent = 'Apply Now';
                    applyButton.disabled = false;
                }
            };
            
            setupAuthHeader();
            fetchJobDetails();
        });
    </script>
</body>
</html>