<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CuroJobs - Job Details</title>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="css/style.css" media="all">
    <link rel="stylesheet" type="text/css" href="css/responsive.css" media="all">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <div class="main-page-wrapper">
        <header class="theme-main-menu menu-style-one sticky-menu" style="background-color: #244034;">
            <div class="inner-content position-relative">
                <div class="collapse navbar-collapse" id="navbarNav">
                                                <ul class="navbar-nav align-items-lg-center">
                                                    <li class="d-block d-lg-none">
                                                        <div class="logo">
                                                            <a href="index.html" class="d-block">
                                                                <img src="images/logo/logo_01.png" alt="" class="curo">
                                                            </a>
                                                        </div>
                                                    </li>
                                                    <li class="nav-item dropdown">
                                                        <a class="nav-link" href="#" role="button" aria-expanded="false">
                                                            Home
                                                        </a>
                                                    </li>
                                                    <li class="nav-item"><a class="nav-link" href="job-list-v1.html">Find Jobs</a></li>
                                                    <li class="nav-item dropdown">
                                                        <a class="nav-link" href="index.html#candidates-employees" role="button" aria-expanded="false">
                                                            For Candidates & Employees
                                                        </a>
                                                    </li>
                                                    <li class="nav-item dropdown">
                                                        <a class="nav-link" href="index.html#recruiters-employers" role="button" aria-expanded="false">
                                                            For Employers & Recruiters
                                                        </a>
                                                    </li>
                                                    <li class="nav-item">
                                                        <a class="nav-link" href="index.html#contact" role="button">Contact</a>
                                                    </li>
                                                    <li class="d-md-none"><a href="#" class="job-post-btn tran3s">Post Job</a></li>
                                                    <li class="d-md-none"><a href="#" class="btn-one w-100">Hire Top Talents</a></li>
                                                </ul>
                                            </div>
            </div>
        </header>

        <section class="job-title-section bg-color" style="padding-top: 150px; padding-bottom: 30px;">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div>
                        <h2 class="main-title" id="job-main-title">Loading...</h2>
                        <ul class="job-meta-data d-flex style-none mt-10" id="job-meta-info"></ul>
                    </div>
                    <div class="mt-2 mt-sm-0" id="apply-button-header-container"></div>
                </div>
            </div>
        </section>

        <section class="job-details-section pt-80 lg-pt-60 pb-100 lg-pb-80">
            <div class="container">
                <div class="row">
                    <div class="col-xxl-9 col-xl-8">
                        <div class="details-post-data me-xxl-5 pe-xxl-4" id="job-details-container">
                            <div class="text-center p-5"><h4>Loading job description...</h4></div>
                        </div>
                    </div>
                    <div class="col-xxl-3 col-xl-4">
                        <div class="job-company-info ms-xl-5 ms-xxl-0 lg-mt-50" id="company-info-container">
                            <div class="text-center p-4 border rounded-3"><p>Loading company info...</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <div class="footer-one">
             <div class="bottom-footer"><div class="container"><p class="text-center mb-15">Copyright @2025 Curo Jobs Inc.</p></div></div>
        </div>
    </div>

    <script src="vendor/jwt-decode.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const jobId = params.get('id');
            const jobTitleEl = document.getElementById('job-main-title');
            const jobMetaContainer = document.getElementById('job-meta-info');
            const jobDetailsContainer = document.getElementById('job-details-container');
            const companyInfoContainer = document.getElementById('company-info-container');
            const authLinksContainer = document.getElementById('auth-links');
            const applyBtnHeaderContainer = document.getElementById('apply-button-header-container');
            
            const jobsApiURL = 'http://127.0.0.1:8000/api/v1/jobs/';
            const accountsApiURL = 'http://127.0.0.1:8000/api/v1/accounts/';

            if (!jobId) {
                jobTitleEl.textContent = "Error";
                jobDetailsContainer.innerHTML = '<h3 class="text-center p-5 text-danger">Job ID is missing.</h3>';
                return;
            }

            const setupAuthHeader = () => {
                const accessToken = localStorage.getItem('accessToken');
                if (accessToken) {
                    try {
                        const decodedToken = jwt_decode(accessToken);
                        let dashboardUrl = (decodedToken.user_type === 'applicant') 
                            ? 'dashboard/applicant/candidate-dashboard-index.html' 
                            : 'dashboard/employer/employer-dashboard-index.html';
                        authLinksContainer.innerHTML = `<li><a href="${dashboardUrl}" class="login-btn-one">Dashboard</a></li><li class="d-none d-md-block ms-4"><a href="#" id="logout-btn" class="btn-one">Logout</a></li>`;
                        document.getElementById('logout-btn')?.addEventListener('click', (e) => {
                            e.preventDefault();
                            localStorage.clear();
                            window.location.href = 'index.html';
                        });
                    } catch(e) {
                         localStorage.clear();
                         authLinksContainer.innerHTML = `<li><a href="login.html" class="login-btn-one">Login</a></li> <li class="d-none d-md-block ms-4"><a href="signup.html" class="btn-one">Sign Up</a></li>`;
                    }
                } else {
                    authLinksContainer.innerHTML = `<li><a href="login.html" class="login-btn-one">Login</a></li> <li class="d-none d-md-block ms-4"><a href="signup.html" class="btn-one">Sign Up</a></li>`;
                }
            };

            const fetchJobDetails = async () => {
                try {
                    const accessToken = localStorage.getItem('accessToken');
                    const headers = { 'Content-Type': 'application/json' };
                    if (accessToken) { headers['Authorization'] = `Bearer ${accessToken}`; }
                    
                    const response = await fetch(`${jobsApiURL}${jobId}/`, { headers });
                    if (!response.ok) throw new Error('Job not found.');
                    const job = await response.json();
                    
                    document.title = `${job.title} | CuroJobs`;
                    jobTitleEl.textContent = job.title;

                    jobMetaContainer.innerHTML = `<li class="border-end pe-3 me-3"><i class="bi bi-briefcase"></i> ${job.job_type || 'N/A'}</li><li class="border-end pe-3 me-3"><i class="bi bi-geo-alt"></i> ${job.location || 'N/A'}</li><li><i class="bi bi-currency-dollar"></i> ${job.salary || 'N/A'}</li>`;
                    jobDetailsContainer.innerHTML = `<div class="post-block"><h4>Overview</h4><p>${job.description ? job.description.replace(/\n/g, '<br>') : 'No description available.'}</p></div>`;

                    const companyInitial = job.company_name ? job.company_name.charAt(0).toUpperCase() : '?';
                    companyInfoContainer.innerHTML = `<a href="company-details.html?id=${job.company_id}" class="logo d-flex align-items-center justify-content-center" style="background-color: #f0f5ff; width: 60px; height: 60px; border-radius: 8px; font-size: 30px; font-weight: 500; color: #4866a6; margin: 0 auto; text-decoration: none;">${companyInitial}</a><div class="text-center mt-20"><a href="company-details.html?id=${job.company_id}" class="company-name fw-500 text-dark tran3s">${job.company_name}</a></div><a href="${job.company_website_url || '#'}" class="website-btn-one tran3s d-flex align-items-center justify-content-center mt-20" target="_blank"><span>Visit website</span><i class="bi bi-arrow-right"></i></a><div id="apply-button-sidebar-container" class="mt-25"></div>`;

                    const applyButtonContainers = [applyBtnHeaderContainer, document.getElementById('apply-button-sidebar-container')];
                    const decodedToken = accessToken ? jwt_decode(accessToken) : null;

                    if (decodedToken && decodedToken.user_type === 'applicant') {
                        if (job.application_status) {
                            const statusText = job.application_status.charAt(0).toUpperCase() + job.application_status.slice(1);
                            applyButtonContainers.forEach(c => { if(c) c.innerHTML = `<button class="btn-soft-success w-100" disabled>Status: ${statusText}</button>`; });
                        } else {
                            applyButtonContainers.forEach(c => { if(c) c.innerHTML = `<button class="btn-one w-100 tran3s apply-btn">Apply Now</button>`; });
                        }
                    } else if (!decodedToken) {
                         applyButtonContainers.forEach(c => { if(c) c.innerHTML = `<a href="login.html" class="btn-one w-100 tran3s">Apply Now</a>`; });
                    } else {
                        applyButtonContainers.forEach(c => { if(c) c.innerHTML = ''; });
                    }

                    document.querySelectorAll('.apply-btn').forEach(btn => btn.addEventListener('click', handleApply));

                } catch (error) {
                    jobTitleEl.textContent = "Job Not Found";
                    jobDetailsContainer.innerHTML = '<h3 class="text-center p-5 text-danger">Job Not Found</h3><p class="text-center">The job you are looking for does not exist or has been removed.</p>';
                    companyInfoContainer.innerHTML = '';
                    applyBtnHeaderContainer.innerHTML = '';
                }
            };
            
            // --- THIS IS THE NEW, SMARTER handleApply FUNCTION ---
            const handleApply = async () => {
                const accessToken = localStorage.getItem('accessToken');
                
                if (!accessToken) {
                    Swal.fire('Login Required', 'Please log in as an applicant to apply for jobs.', 'info').then(() => window.location.href = 'login.html');
                    return;
                }
                
                try {
                    const decodedToken = jwt_decode(accessToken);
                    if (decodedToken.user_type !== 'applicant') {
                        Swal.fire('Incorrect Account Type', 'Only applicants can apply for jobs. Please log in with an applicant account.', 'warning');
                        return;
                    }
                } catch(e) {
                    Swal.fire('Session Invalid', 'Your session is invalid. Please log in again.', 'error').then(() => { localStorage.clear(); window.location.href = 'login.html'; });
                    return;
                }

                const applyButtons = document.querySelectorAll('.apply-btn');
                applyButtons.forEach(btn => { if(btn) { btn.textContent = 'Checking Profile...'; btn.disabled = true; }});

                try {
                    // 1. Check if the applicant's profile is complete
                    const profileResponse = await fetch(`${accountsApiURL}profile/applicant/`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    if (!profileResponse.ok) throw new Error('Could not verify your profile.');
                    const profile = await profileResponse.json();

                    // Define what makes a profile "incomplete" (e.g., no full name OR no CV)
                    if (!profile.full_name || !profile.cv) {
                        Swal.fire({
                            title: 'Incomplete Profile!',
                            html: 'To apply for jobs, you need to complete your profile and upload a CV.<br><br>Would you like to do that now?',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#244034',
                            confirmButtonText: 'Go to My Profile',
                            cancelButtonText: 'Not Now'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = 'dashboard/applicant/candidate-dashboard-profile.html';
                            }
                        });
                        // Reset apply buttons since the application was cancelled
                        applyButtons.forEach(btn => { if(btn) { btn.textContent = 'Apply Now'; btn.disabled = false; }});
                        return; // Stop the application process
                    }
                    
                    // 2. If profile is complete, proceed with the application
                    applyButtons.forEach(btn => { if(btn) btn.textContent = 'Applying...'; });

                    const applyResponse = await fetch(`${jobsApiURL}${jobId}/apply/`, { 
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }
                    });
                    
                    if (!applyResponse.ok) {
                        const result = await applyResponse.json();
                        throw new Error(result.detail || 'Application failed. You may have already applied for this job.');
                    }
                    
                    Swal.fire('Success!', 'Your application was successful!', 'success');
                    fetchJobDetails(); // Refresh the page to show the new "Status" button

                } catch (error) {
                    Swal.fire('Application Failed', error.message, 'error');
                    // Reset apply buttons on failure
                     const applyButtonContainers = [applyBtnHeaderContainer, document.getElementById('apply-button-sidebar-container')];
                     applyButtonContainers.forEach(container => {
                        if(container) container.innerHTML = `<button class="btn-one w-100 tran3s apply-btn">Apply Now</button>`;
                     });
                     document.querySelectorAll('.apply-btn').forEach(btn => btn.addEventListener('click', handleApply));
                }
            };
            
            setupAuthHeader();
            fetchJobDetails();
        });
    </script>
</body>
</html>