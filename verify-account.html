<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Your Account | CuroJobs</title>
    <link rel="icon" type="image/png" sizes="56x56" href="images/fav-icon/icon.png">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="css/style.css" media="all">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        /* Basic centering and card styling */
        .vh-100 { min-height: 100vh; } 
        .verification-card {
            background: #fff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }
        .icon-box {
            width: 60px;
            height: 60px;
            line-height: 60px;
            margin: 0 auto 20px;
            background: #e8f7ee;
            color: #20a64d;
            border-radius: 50%;
            font-size: 28px;
        }
        .error-icon-box {
            background: #fce8e6;
            color: #ea4335;
        }
        /* Ensure buttons are properly sized in their containers */
        .centered-button-wrapper {
            text-align: center; 
        }
        #login-button, #resend-button {
            display: inline-block !important;
            padding: 10px 30px; 
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div class="d-flex align-items-center justify-content-center vh-100">
        <div class="verification-card text-center">
            
            <div id="icon-placeholder" class="icon-box">
                <i class="bi bi-clock-history"></i>
            </div>

            <h2 id="message-title" class="mb-3">Verifying your account...</h2>
            <p id="message-body" class="mt-3 text-muted">Please wait while we confirm your verification link with the server.</p>
            
            <div class="centered-button-wrapper">
                 <a href="login.html" id="login-button" class="btn-eleven fw-500 tran3s mt-4" style="display: none;">
                    <i class="bi bi-box-arrow-in-right me-2"></i> Go to Login
                </a>
            </div>
            
            <div id="resend-container" class="mt-4 pt-3 border-top" style="display: none;">
                <p class="mb-3 fw-bold text-danger" id="resend-message-lead">Link Invalid/Expired. Need help?</p>
                <div class="centered-button-wrapper">
                    <button id="resend-button" class="dash-btn-two tran3s">
                        Resend Verification Link
                    </button>
                </div>
                <p id="timer-message" class="mt-2 text-muted" style="display: none; font-size: 0.9em;"></p>
                <p id="resend-status" class="mt-2" style="display: none;"></p>
            </div>
        </div>
    </div>

    <script src="vendor/jwt-decode.js"></script> 
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const titleEl = document.getElementById('message-title');
            const bodyEl = document.getElementById('message-body');
            const loginBtn = document.getElementById('login-button');
            const resendContainer = document.getElementById('resend-container');
            const resendBtn = document.getElementById('resend-button');
            const timerMsg = document.getElementById('timer-message');
            const resendMessageLead = document.getElementById('resend-message-lead');
            const resendStatus = document.getElementById('resend-status');
            const iconPlaceholder = document.getElementById('icon-placeholder');

            const params = new URLSearchParams(window.location.search);
            const uid = params.get('uid');
            const token = params.get('token');
            const emailInUrl = params.get('email');
            
            // --- API Endpoints ---
            const VERIFY_API_URL = 'http://127.0.0.1:8000/api/v1/accounts/verify-email/';
            const RESEND_API_URL = 'http://127.0.0.1:8000/api/v1/accounts/resend-verification/';

            // Helper to set UI
            const setStatusUI = (status, title, message) => {
                titleEl.textContent = title;
                bodyEl.textContent = message;
                iconPlaceholder.className = 'icon-box'; 
                
                if (status === 'success') {
                    iconPlaceholder.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
                } else if (status === 'fail') {
                    iconPlaceholder.innerHTML = '<i class="bi bi-x-octagon-fill"></i>';
                    iconPlaceholder.classList.add('error-icon-box');
                } else {
                    iconPlaceholder.innerHTML = '<i class="bi bi-envelope-check-fill"></i>';
                }
            };

            // Smart Timer Logic
            const startResendTimer = () => {
                let countdown = 60;
                resendBtn.disabled = true;
                timerMsg.style.display = 'block';
                
                const interval = setInterval(() => {
                    countdown--;
                    timerMsg.textContent = `You can resend in ${countdown} seconds.`;
                    if (countdown <= 0) {
                        clearInterval(interval);
                        timerMsg.style.display = 'none';
                        resendBtn.disabled = false;
                        resendStatus.style.display = 'none'; 
                    }
                }, 1000);
            };

            // --- RESEND HANDLER FUNCTION ---
            const handleResend = async () => {
                const userEmail = localStorage.getItem('verificationEmail');

                if (!userEmail) {
                    resendStatus.textContent = "Error: Cannot find your email address.";
                    resendStatus.style.display = 'block';
                    return;
                }

                resendBtn.disabled = true;
                resendStatus.style.display = 'none';

                try {
                    const response = await fetch(RESEND_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: userEmail }),
                    });
                    const result = await response.json();
                    
                    if (response.ok) {
                        resendStatus.className = 'mt-2 text-success';
                        resendStatus.textContent = `Success! ${result.detail}`;
                        startResendTimer();
                    } else {
                         resendStatus.className = 'mt-2 text-danger';
                         resendStatus.textContent = `Error: ${result.detail || 'Could not resend link.'}`;
                         if (!timerMsg.style.display || timerMsg.style.display === 'none') resendBtn.disabled = false;
                    }
                    resendStatus.style.display = 'block';
                } catch (error) {
                    resendStatus.className = 'mt-2 text-danger';
                    resendStatus.textContent = "An error occurred during resend. Check your network or server logs.";
                    resendStatus.style.display = 'block';
                    resendBtn.disabled = false; 
                    console.error('Resend error:', error);
                }

                if(resendBtn.disabled) startResendTimer();
            };

            // --- CORE VERIFICATION LOGIC ---
            
            // Case 1: Arriving via email link (UID & TOKEN)
            if (uid && token) {
                (async () => {
                    try {
                        const response = await fetch(VERIFY_API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ uid: uid, token: token }),
                        });
                        const result = await response.json();
                        
                        if (response.ok) {
                            setStatusUI('success', 'Account Verified! âœ…', result.detail);
                            loginBtn.style.display = 'block'; 
                        } else {
                            setStatusUI('fail', 'Verification Failed', result.detail || 'The verification link is invalid or has expired.');
                            if (emailInUrl || localStorage.getItem('verificationEmail')) {
                                resendContainer.style.display = 'block';
                            }
                        }
                    } catch (error) {
                        setStatusUI('fail', 'Network Error', 'Could not connect to the API server. Please check network/server status.');
                        if (emailInUrl || localStorage.getItem('verificationEmail')) resendContainer.style.display = 'block';
                    }
                    if (emailInUrl) localStorage.setItem('verificationEmail', emailInUrl);
                })();

            } 
            // Case 2: Arriving from registration success (No UID/Token, but has email)
            else if (emailInUrl) {
                setStatusUI('pending', 'Verification Email Sent!', `Please check your inbox at ${emailInUrl} to verify your account.`);
                resendContainer.style.display = 'block';
                resendMessageLead.textContent = "Didn't receive it? Check spam or resend below.";
                localStorage.setItem('verificationEmail', emailInUrl);
            } 
            // Case 3: Error / Invalid State
            else {
                setStatusUI('fail', 'Error: Missing Link Data', 'You accessed this page without the necessary verification data. Please check your email or return to login.');
                loginBtn.style.display = 'block';
            }


            // --- ATTACH RESEND EVENT LISTENER ---
            resendBtn.addEventListener('click', handleResend);
        });
    </script>